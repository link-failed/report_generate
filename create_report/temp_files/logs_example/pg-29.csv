2022-07-29 15:56:27.372 PDT,,,63718,"localhost:50922",62e4659b.f8e6,1,"",2022-07-29 15:56:27 PDT,,0,LOG,00000,"connection received: host=localhost port=50922",,,,,,,,,""
2022-07-29 15:56:27.381 PDT,"ceci","mimic",63718,"localhost:50922",62e4659b.f8e6,2,"authentication",2022-07-29 15:56:27 PDT,3/2109,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 15:56:27.384 PDT,"ceci","mimic",63718,"localhost:50922",62e4659b.f8e6,3,"idle",2022-07-29 15:56:27 PDT,3/2110,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.385 PDT,"ceci","mimic",63718,"localhost:50922",62e4659b.f8e6,4,"BEGIN",2022-07-29 15:56:27 PDT,3/2110,0,LOG,00000,"duration: 2.332 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.385 PDT,"ceci","mimic",63718,"localhost:50922",62e4659b.f8e6,5,"idle in transaction",2022-07-29 15:56:27 PDT,3/2110,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_mimic""} */

    select distinct nspname from pg_namespace
  ",,,,,,,,,"dbt"
2022-07-29 15:56:27.388 PDT,"ceci","mimic",63718,"localhost:50922",62e4659b.f8e6,6,"SELECT",2022-07-29 15:56:27 PDT,3/2110,0,LOG,00000,"duration: 2.703 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.419 PDT,,,63720,"localhost:50924",62e4659b.f8e8,1,"",2022-07-29 15:56:27 PDT,,0,LOG,00000,"connection received: host=localhost port=50924",,,,,,,,,""
2022-07-29 15:56:27.424 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,2,"authentication",2022-07-29 15:56:27 PDT,3/2111,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 15:56:27.425 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,3,"idle",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.425 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,4,"BEGIN",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"duration: 0.125 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.426 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,5,"idle in transaction",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.426 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,6,"BEGIN",2022-07-29 15:56:27 PDT,3/2112,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 15:56:27.426 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,7,"BEGIN",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"duration: 0.095 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.427 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,8,"idle in transaction",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_mimic_public""} */
select
      'mimic' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'mimic' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  ",,,,,,,,,"dbt"
2022-07-29 15:56:27.436 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,9,"SELECT",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"duration: 8.783 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.453 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,10,"idle in transaction",2022-07-29 15:56:27 PDT,3/2112,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 15:56:27.453 PDT,"ceci","mimic",63720,"localhost:50924",62e4659b.f8e8,11,"ROLLBACK",2022-07-29 15:56:27 PDT,3/0,0,LOG,00000,"duration: 0.138 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.491 PDT,,,63721,"localhost:50926",62e4659b.f8e9,1,"",2022-07-29 15:56:27 PDT,,0,LOG,00000,"connection received: host=localhost port=50926",,,,,,,,,""
2022-07-29 15:56:27.498 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,2,"authentication",2022-07-29 15:56:27 PDT,3/2113,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 15:56:27.501 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,3,"idle",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.501 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,4,"BEGIN",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"duration: 0.157 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.501 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,5,"idle in transaction",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.501 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,6,"BEGIN",2022-07-29 15:56:27 PDT,3/2114,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 15:56:27.501 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,7,"BEGIN",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"duration: 0.056 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.504 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,8,"idle in transaction",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""master""} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;",,,,,,,,,"dbt"
2022-07-29 15:56:27.515 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,9,"SELECT",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"duration: 11.606 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.524 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,10,"idle in transaction",2022-07-29 15:56:27 PDT,3/2114,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 15:56:27.524 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,11,"ROLLBACK",2022-07-29 15:56:27 PDT,3/0,0,LOG,00000,"duration: 0.102 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.525 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,12,"idle",2022-07-29 15:56:27 PDT,3/2115,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.526 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,13,"BEGIN",2022-07-29 15:56:27 PDT,3/2115,0,LOG,00000,"duration: 0.061 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.526 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,14,"idle in transaction",2022-07-29 15:56:27 PDT,3/2115,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.526 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,15,"BEGIN",2022-07-29 15:56:27 PDT,3/2115,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 15:56:27.526 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,16,"BEGIN",2022-07-29 15:56:27 PDT,3/2115,0,LOG,00000,"duration: 0.343 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.530 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,17,"idle in transaction",2022-07-29 15:56:27 PDT,3/2115,0,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 15:56:27.530 PDT,"ceci","mimic",63721,"localhost:50926",62e4659b.f8e9,18,"COMMIT",2022-07-29 15:56:27 PDT,3/0,0,LOG,00000,"duration: 0.189 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.631 PDT,,,63727,"localhost:50928",62e4659b.f8ef,1,"",2022-07-29 15:56:27 PDT,,0,LOG,00000,"connection received: host=localhost port=50928",,,,,,,,,""
2022-07-29 15:56:27.637 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,2,"authentication",2022-07-29 15:56:27 PDT,3/2116,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 15:56:27.638 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,3,"idle",2022-07-29 15:56:27 PDT,3/2117,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.638 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,4,"BEGIN",2022-07-29 15:56:27 PDT,3/2117,0,LOG,00000,"duration: 0.116 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.638 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,5,"idle in transaction",2022-07-29 15:56:27 PDT,3/2117,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:27.638 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,6,"BEGIN",2022-07-29 15:56:27 PDT,3/2117,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 15:56:27.638 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,7,"BEGIN",2022-07-29 15:56:27 PDT,3/2117,0,LOG,00000,"duration: 0.083 ms",,,,,,,,,"dbt"
2022-07-29 15:56:27.641 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,8,"idle in transaction",2022-07-29 15:56:27 PDT,3/2117,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */


  create  table ""mimic"".""public"".""kdigo_creatinine__dbt_tmp""
  as (
    -- Extract all creatinine values FROM labevents around patient's ICU stay
with cr as
(
select
    ie.icustay_id
  , ie.intime, ie.outtime
  , le.valuenum as creat
  , le.charttime
  FROM icustays ie
  left join labevents le
    on ie.subject_id = le.subject_id
    and le.ITEMID = 50912
    and le.VALUENUM is not null
    and DATETIME_DIFF(le.charttime, ie.intime, 'HOUR') <= (7*24-6)
    and le.CHARTTIME >= DATETIME_SUB(ie.intime, INTERVAL '6 HOUR')
    and le.CHARTTIME <= DATETIME_ADD(ie.intime, INTERVAL '7 DAY')
)
-- add in the lowest value in the previous 48 hours/7 days
SELECT
  cr.icustay_id
  , cr.charttime
  , cr.creat
  , MIN(cr48.creat) AS creat_low_past_48hr
  , MIN(cr7.creat) AS creat_low_past_7day
FROM cr
-- add in all creatinine values in the last 48 hours
LEFT JOIN cr cr48
  ON cr.icustay_id = cr48.icustay_id
  AND cr48.charttime <  cr.charttime
  AND DATETIME_DIFF(cr.charttime, cr48.charttime, 'HOUR') <= 48
-- add in all creatinine values in the last 7 days
LEFT JOIN cr cr7
  ON cr.icustay_id = cr7.icustay_id
  AND cr7.charttime <  cr.charttime
  AND DATETIME_DIFF(cr.charttime, cr7.charttime, 'DAY') <= 7
GROUP BY cr.icustay_id, cr.charttime, cr.creat
ORDER BY cr.icustay_id, cr.charttime, cr.creat
  );",,,,,,,,,"dbt"
2022-07-29 15:56:28.495 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,9,"CREATE TABLE AS",2022-07-29 15:56:27 PDT,3/2117,1884,LOG,00000,"duration: 854.103 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.514 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,10,"idle in transaction",2022-07-29 15:56:27 PDT,3/2117,1884,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */
alter table ""mimic"".""public"".""kdigo_creatinine"" rename to ""kdigo_creatinine__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 15:56:28.517 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,11,"ALTER TABLE",2022-07-29 15:56:27 PDT,3/2117,1884,LOG,00000,"duration: 3.741 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.525 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,12,"idle in transaction",2022-07-29 15:56:27 PDT,3/2117,1884,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */
alter table ""mimic"".""public"".""kdigo_creatinine__dbt_tmp"" rename to ""kdigo_creatinine""",,,,,,,,,"dbt"
2022-07-29 15:56:28.525 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,13,"ALTER TABLE",2022-07-29 15:56:27 PDT,3/2117,1884,LOG,00000,"duration: 0.353 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.548 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,14,"idle in transaction",2022-07-29 15:56:27 PDT,3/2117,1884,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 15:56:28.560 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,15,"COMMIT",2022-07-29 15:56:27 PDT,3/0,0,LOG,00000,"duration: 12.316 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.573 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,16,"idle",2022-07-29 15:56:27 PDT,3/2118,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_creatinine""} */
drop table if exists ""mimic"".""public"".""kdigo_creatinine__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 15:56:28.576 PDT,"ceci","mimic",63727,"localhost:50928",62e4659b.f8ef,17,"DROP TABLE",2022-07-29 15:56:27 PDT,3/0,0,LOG,00000,"duration: 3.185 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.629 PDT,,,63741,"localhost:50930",62e4659c.f8fd,1,"",2022-07-29 15:56:28 PDT,,0,LOG,00000,"connection received: host=localhost port=50930",,,,,,,,,""
2022-07-29 15:56:28.639 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,2,"authentication",2022-07-29 15:56:28 PDT,3/2119,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 15:56:28.641 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,3,"idle",2022-07-29 15:56:28 PDT,3/2120,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:28.641 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,4,"BEGIN",2022-07-29 15:56:28 PDT,3/2120,0,LOG,00000,"duration: 0.108 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.641 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,5,"idle in transaction",2022-07-29 15:56:28 PDT,3/2120,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 15:56:28.641 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,6,"BEGIN",2022-07-29 15:56:28 PDT,3/2120,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 15:56:28.642 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,7,"BEGIN",2022-07-29 15:56:28 PDT,3/2120,0,LOG,00000,"duration: 0.556 ms",,,,,,,,,"dbt"
2022-07-29 15:56:28.644 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,8,"idle in transaction",2022-07-29 15:56:28 PDT,3/2120,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_uo""} */


  create  table ""mimic"".""public"".""kdigo_uo__dbt_tmp""
  as (
    with ur_stg as
(
  select io.icustay_id, io.charttime
  -- we have joined each row to all rows preceding within 24 hours
  -- we can now sum these rows to get total UO over the last 24 hours
  -- we can use case statements to restrict it to only the last 6/12 hours
  -- therefore we have three sums:
  -- 1) over a 6 hour period
  -- 2) over a 12 hour period
  -- 3) over a 24 hour period

  -- note that we assume data charted at charttime corresponds to 1 hour of UO
  -- therefore we use '5' and '11' to restrict the period, rather than 6/12
  -- this assumption may overestimate UO rate when documentation is done less than hourly
  , sum(case when DATETIME_DIFF(io.charttime, iosum.charttime, 'HOUR') <= 5
      then iosum.VALUE
    else null end) as urineoutput_6hr
  , sum(case when DATETIME_DIFF(io.charttime, iosum.charttime, 'HOUR') <= 11
      then iosum.VALUE
    else null end) as urineoutput_12hr
  -- 24 hours
  , sum(iosum.VALUE) as urineoutput_24hr

  -- retain the earliest time used for each summation
  -- this is later used to tabulate rates
  , MIN(case when io.charttime <= DATETIME_ADD(iosum.charttime, INTERVAL '5 HOUR')
      then iosum.charttime
    else null end)
    AS starttime_6hr
  , MIN(case when io.charttime <= DATETIME_ADD(iosum.charttime, INTERVAL '11 HOUR')
      then iosum.charttime
    else null end)
    AS starttime_12hr
  , MIN(iosum.charttime) AS starttime_24hr
  from ""mimic"".""public"".""urine_output"" io
  -- this join gives you all UO measurements over a 24 hour period
  left join ""mimic"".""public"".""urine_output"" iosum
    on  io.icustay_id = iosum.icustay_id
    and io.charttime >= iosum.charttime
    and io.charttime <= (DATETIME_ADD(iosum.charttime, INTERVAL '23 HOUR'))
  group by io.icustay_id, io.charttime
)
-- calculate hours used to sum UO over
, ur_stg2 AS
(
  select
    icustay_id
  , charttime
  , urineoutput_6hr
  , urineoutput_12hr
  , urineoutput_24hr
  -- calculate time over which we summed UO
  -- note: adding 1 hour as we assume data charted corresponds to previous hour
  -- i.e. if documentation is:
  --  10:00, 100 mL
  --  11:00, 50 mL
  -- then this is two hours of documentation, even though (11:00 - 10:00) is 1 hour
  , ROUND(DATETIME_DIFF(charttime, starttime_6hr, 'HOUR'), 4) + 1 AS uo_tm_6hr
  , ROUND(DATETIME_DIFF(charttime, starttime_12hr, 'HOUR'), 4) + 1 AS uo_tm_12hr
  , ROUND(DATETIME_DIFF(charttime, starttime_24hr, 'HOUR'), 4) + 1 AS uo_tm_24hr
  from ur_stg
)
select
  ur.icustay_id
, ur.charttime
, wd.weight
, ur.urineoutput_6hr
, ur.urineoutput_12hr
, ur.urineoutput_24hr
, ROUND(CAST((ur.urineoutput_6hr/wd.weight/uo_tm_6hr) AS NUMERIC), 4) AS uo_rt_6hr
, ROUND(CAST((ur.urineoutput_12hr/wd.weight/uo_tm_12hr) AS NUMERIC), 4) AS uo_rt_12hr
, ROUND(CAST((ur.urineoutput_24hr/wd.weight/uo_tm_24hr) AS NUMERIC), 4) AS uo_rt_24hr
-- time of earliest UO measurement that was used to calculate the rate
, uo_tm_6hr
, uo_tm_12hr
, uo_tm_24hr
from ur_stg2 ur
left join ""mimic"".""public"".""weight_durations"" wd
  on  ur.icustay_id = wd.icustay_id
  and ur.charttime >= wd.starttime
  and ur.charttime <  wd.endtime
order by icustay_id, charttime
  );",,,,,,,,,"dbt"
2022-07-29 16:00:09.639 PDT,,,64442,"localhost:51304",62e46679.fbba,1,"",2022-07-29 16:00:09 PDT,,0,LOG,00000,"connection received: host=localhost port=51304",,,,,,,,,""
2022-07-29 16:00:09.645 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,2,"authentication",2022-07-29 16:00:09 PDT,4/51,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:09.646 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,3,"idle",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:09.646 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,4,"BEGIN",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"duration: 0.129 ms",,,,,,,,,"dbt"
2022-07-29 16:00:09.646 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,5,"idle in transaction",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:09.646 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,6,"BEGIN",2022-07-29 16:00:09 PDT,4/52,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:09.646 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,7,"BEGIN",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"duration: 0.103 ms",,,,,,,,,"dbt"
2022-07-29 16:00:09.648 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,8,"idle in transaction",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"statement: select pg_terminate_backend(63741)",,,,,,,,,"dbt"
2022-07-29 16:00:09.648 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,9,"SELECT",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"duration: 0.559 ms",,,,,,,,,"dbt"
2022-07-29 16:00:09.648 PDT,"ceci","mimic",63741,"localhost:50930",62e4659c.f8fd,9,"CREATE TABLE AS",2022-07-29 15:56:28 PDT,3/2120,1886,FATAL,57P01,"terminating connection due to administrator command",,,,,"PL/pgSQL function datetime_diff(timestamp without time zone,timestamp without time zone,text) line 2 at statement block","/* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.kdigo_uo""} */


  create  table ""mimic"".""public"".""kdigo_uo__dbt_tmp""
  as (
    with ur_stg as
(
  select io.icustay_id, io.charttime
  -- we have joined each row to all rows preceding within 24 hours
  -- we can now sum these rows to get total UO over the last 24 hours
  -- we can use case statements to restrict it to only the last 6/12 hours
  -- therefore we have three sums:
  -- 1) over a 6 hour period
  -- 2) over a 12 hour period
  -- 3) over a 24 hour period

  -- note that we assume data charted at charttime corresponds to 1 hour of UO
  -- therefore we use '5' and '11' to restrict the period, rather than 6/12
  -- this assumption may overestimate UO rate when documentation is done less than hourly
  , sum(case when DATETIME_DIFF(io.charttime, iosum.charttime, 'HOUR') <= 5
      then iosum.VALUE
    else null end) as urineoutput_6hr
  , sum(case when DATETIME_DIFF(io.charttime, iosum.charttime, 'HOUR') <= 11
      then iosum.VALUE
    else null end) as urineoutput_12hr
  -- 24 hours
  , sum(iosum.VALUE) as urineoutput_24hr

  -- retain the earliest time used for each summation
  -- this is later used to tabulate rates
  , MIN(case when io.charttime <= DATETIME_ADD(iosum.charttime, INTERVAL '5 HOUR')
      then iosum.charttime
    else null end)
    AS starttime_6hr
  , MIN(case when io.charttime <= DATETIME_ADD(iosum.charttime, INTERVAL '11 HOUR')
      then iosum.charttime
    else null end)
    AS starttime_12hr
  , MIN(iosum.charttime) AS starttime_24hr
  from ""mimic"".""public"".""urine_output"" io
  -- this join gives you all UO measurements over a 24 hour period
  left join ""mimic"".""public"".""urine_output"" iosum
    on  io.icustay_id = iosum.icustay_id
    and io.charttime >= iosum.charttime
    and io.charttime <= (DATETIME_ADD(iosum.charttime, INTERVAL '23 HOUR'))
  group by io.icustay_id, io.charttime
)
-- calculate hours used to sum UO over
, ur_stg2 AS
(
  select
    icustay_id
  , charttime
  , urineoutput_6hr
  , urineoutput_12hr
  , urineoutput_24hr
  -- calculate time over which we summed UO
  -- note: adding 1 hour as we assume data charted corresponds to previous hour
  -- i.e. if documentation is:
  --  10:00, 100 mL
  --  11:00, 50 mL
  -- then this is two hours of documentation, even though (11:00 - 10:00) is 1 hour
  , ROUND(DATETIME_DIFF(charttime, starttime_6hr, 'HOUR'), 4) + 1 AS uo_tm_6hr
  , ROUND(DATETIME_DIFF(charttime, starttime_12hr, 'HOUR'), 4) + 1 AS uo_tm_12hr
  , ROUND(DATETIME_DIFF(charttime, starttime_24hr, 'HOUR'), 4) + 1 AS uo_tm_24hr
  from ur_stg
)
select
  ur.icustay_id
, ur.charttime
, wd.weight
, ur.urineoutput_6hr
, ur.urineoutput_12hr
, ur.urineoutput_24hr
, ROUND(CAST((ur.urineoutput_6hr/wd.weight/uo_tm_6hr) AS NUMERIC), 4) AS uo_rt_6hr
, ROUND(CAST((ur.urineoutput_12hr/wd.weight/uo_tm_12hr) AS NUMERIC), 4) AS uo_rt_12hr
, ROUND(CAST((ur.urineoutput_24hr/wd.weight/uo_tm_24hr) AS NUMERIC), 4) AS uo_rt_24hr
-- time of earliest UO measurement that was used to calculate the rate
, uo_tm_6hr
, uo_tm_12hr
, uo_tm_24hr
from ur_stg2 ur
left join ""mimic"".""public"".""weight_durations"" wd
  on  ur.icustay_id = wd.icustay_id
  and ur.charttime >= wd.starttime
  and ur.charttime <  wd.endtime
order by icustay_id, charttime
  );",,,"dbt"
2022-07-29 16:00:09.650 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,10,"idle in transaction",2022-07-29 16:00:09 PDT,4/52,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 16:00:09.650 PDT,"ceci","mimic",64442,"localhost:51304",62e46679.fbba,11,"ROLLBACK",2022-07-29 16:00:09 PDT,4/0,0,LOG,00000,"duration: 0.153 ms",,,,,,,,,"dbt"
2022-07-29 16:00:29.952 PDT,,,64564,"localhost:51350",62e4668d.fc34,1,"",2022-07-29 16:00:29 PDT,,0,LOG,00000,"connection received: host=localhost port=51350",,,,,,,,,""
2022-07-29 16:00:29.960 PDT,"ceci","mimic",64564,"localhost:51350",62e4668d.fc34,2,"authentication",2022-07-29 16:00:29 PDT,3/2123,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:29.963 PDT,"ceci","mimic",64564,"localhost:51350",62e4668d.fc34,3,"idle",2022-07-29 16:00:29 PDT,3/2124,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:29.963 PDT,"ceci","mimic",64564,"localhost:51350",62e4668d.fc34,4,"BEGIN",2022-07-29 16:00:29 PDT,3/2124,0,LOG,00000,"duration: 0.198 ms",,,,,,,,,"dbt"
2022-07-29 16:00:29.964 PDT,"ceci","mimic",64564,"localhost:51350",62e4668d.fc34,5,"idle in transaction",2022-07-29 16:00:29 PDT,3/2124,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_mimic""} */

    select distinct nspname from pg_namespace
  ",,,,,,,,,"dbt"
2022-07-29 16:00:29.965 PDT,"ceci","mimic",64564,"localhost:51350",62e4668d.fc34,6,"SELECT",2022-07-29 16:00:29 PDT,3/2124,0,LOG,00000,"duration: 1.032 ms",,,,,,,,,"dbt"
2022-07-29 16:00:29.996 PDT,,,64568,"localhost:51352",62e4668d.fc38,1,"",2022-07-29 16:00:29 PDT,,0,LOG,00000,"connection received: host=localhost port=51352",,,,,,,,,""
2022-07-29 16:00:30.000 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,2,"authentication",2022-07-29 16:00:29 PDT,3/2125,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:30.001 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,3,"idle",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.001 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,4,"BEGIN",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"duration: 0.082 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.001 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,5,"idle in transaction",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.001 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,6,"BEGIN",2022-07-29 16:00:29 PDT,3/2126,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.001 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,7,"BEGIN",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"duration: 0.036 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.003 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,8,"idle in transaction",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_mimic_public""} */
select
      'mimic' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'mimic' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  ",,,,,,,,,"dbt"
2022-07-29 16:00:30.007 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,9,"SELECT",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"duration: 4.400 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.022 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,10,"idle in transaction",2022-07-29 16:00:29 PDT,3/2126,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 16:00:30.022 PDT,"ceci","mimic",64568,"localhost:51352",62e4668d.fc38,11,"ROLLBACK",2022-07-29 16:00:29 PDT,3/0,0,LOG,00000,"duration: 0.238 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.050 PDT,,,64572,"localhost:51354",62e4668e.fc3c,1,"",2022-07-29 16:00:30 PDT,,0,LOG,00000,"connection received: host=localhost port=51354",,,,,,,,,""
2022-07-29 16:00:30.057 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,2,"authentication",2022-07-29 16:00:30 PDT,3/2127,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:30.060 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,3,"idle",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.060 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,4,"BEGIN",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"duration: 0.284 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.060 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,5,"idle in transaction",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.060 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,6,"BEGIN",2022-07-29 16:00:30 PDT,3/2128,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.060 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,7,"BEGIN",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"duration: 0.064 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.062 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,8,"idle in transaction",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""master""} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;",,,,,,,,,"dbt"
2022-07-29 16:00:30.068 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,9,"SELECT",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"duration: 6.160 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.081 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,10,"idle in transaction",2022-07-29 16:00:30 PDT,3/2128,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 16:00:30.082 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,11,"ROLLBACK",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 0.487 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.084 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,12,"idle",2022-07-29 16:00:30 PDT,3/2129,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.084 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,13,"BEGIN",2022-07-29 16:00:30 PDT,3/2129,0,LOG,00000,"duration: 0.070 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.084 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,14,"idle in transaction",2022-07-29 16:00:30 PDT,3/2129,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.084 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,15,"BEGIN",2022-07-29 16:00:30 PDT,3/2129,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.084 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,16,"BEGIN",2022-07-29 16:00:30 PDT,3/2129,0,LOG,00000,"duration: 0.059 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.086 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,17,"idle in transaction",2022-07-29 16:00:30 PDT,3/2129,0,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:30.086 PDT,"ceci","mimic",64572,"localhost:51354",62e4668e.fc3c,18,"COMMIT",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 0.382 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.175 PDT,,,64581,"localhost:51356",62e4668e.fc45,1,"",2022-07-29 16:00:30 PDT,,0,LOG,00000,"connection received: host=localhost port=51356",,,,,,,,,""
2022-07-29 16:00:30.180 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,2,"authentication",2022-07-29 16:00:30 PDT,3/2130,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:30.183 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,3,"idle",2022-07-29 16:00:30 PDT,3/2131,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.183 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,4,"BEGIN",2022-07-29 16:00:30 PDT,3/2131,0,LOG,00000,"duration: 0.247 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.183 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,5,"idle in transaction",2022-07-29 16:00:30 PDT,3/2131,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.183 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,6,"BEGIN",2022-07-29 16:00:30 PDT,3/2131,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.183 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,7,"BEGIN",2022-07-29 16:00:30 PDT,3/2131,0,LOG,00000,"duration: 0.056 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.185 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,8,"idle in transaction",2022-07-29 16:00:30 PDT,3/2131,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */


  create  table ""mimic"".""public"".""blood_gas_first_day__dbt_tmp""
  as (
    -- The aim of this query is to pivot entries related to blood gases and
-- chemistry values which were found in LABEVENTS

-- things to check:
--  when a mixed venous/arterial blood sample are taken at the same time, is the store time different?

with pvt as
( -- begin query that extracts the data
  select ie.subject_id, ie.hadm_id, ie.icustay_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
      , case
        when itemid = 50800 then 'SPECIMEN'
        when itemid = 50801 then 'AADO2'
        when itemid = 50802 then 'BASEEXCESS'
        when itemid = 50803 then 'BICARBONATE'
        when itemid = 50804 then 'TOTALCO2'
        when itemid = 50805 then 'CARBOXYHEMOGLOBIN'
        when itemid = 50806 then 'CHLORIDE'
        when itemid = 50808 then 'CALCIUM'
        when itemid = 50809 then 'GLUCOSE'
        when itemid = 50810 then 'HEMATOCRIT'
        when itemid = 50811 then 'HEMOGLOBIN'
        when itemid = 50812 then 'INTUBATED'
        when itemid = 50813 then 'LACTATE'
        when itemid = 50814 then 'METHEMOGLOBIN'
        when itemid = 50815 then 'O2FLOW'
        when itemid = 50816 then 'FIO2'
        when itemid = 50817 then 'SO2' -- OXYGENSATURATION
        when itemid = 50818 then 'PCO2'
        when itemid = 50819 then 'PEEP'
        when itemid = 50820 then 'PH'
        when itemid = 50821 then 'PO2'
        when itemid = 50822 then 'POTASSIUM'
        when itemid = 50823 then 'REQUIREDO2'
        when itemid = 50824 then 'SODIUM'
        when itemid = 50825 then 'TEMPERATURE'
        when itemid = 50826 then 'TIDALVOLUME'
        when itemid = 50827 then 'VENTILATIONRATE'
        when itemid = 50828 then 'VENTILATOR'
        else null
        end as label
        , charttime
        , value
        -- add in some sanity checks on the values
        , case
          when valuenum <= 0 and itemid != 50802 then null -- allow negative baseexcess
          when itemid = 50810 and valuenum > 100 then null -- hematocrit
          -- ensure FiO2 is a valid number between 21-100
          -- mistakes are rare (<100 obs out of ~100,000)
          -- there are 862 obs of valuenum == 20 - some people round down!
          -- rather than risk imputing garbage data for FiO2, we simply NULL invalid values
          when itemid = 50816 and valuenum < 20 then null
          when itemid = 50816 and valuenum > 100 then null
          when itemid = 50817 and valuenum > 100 then null -- O2 sat
          when itemid = 50815 and valuenum >  70 then null -- O2 flow
          when itemid = 50821 and valuenum > 800 then null -- PO2
           -- conservative upper limit
        else valuenum
        end as valuenum

    FROM icustays ie
    left join labevents le
      on le.subject_id = ie.subject_id and le.hadm_id = ie.hadm_id
      and le.charttime between (DATETIME_SUB(ie.intime, INTERVAL '6' HOUR)) and (DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
      and le.ITEMID in
      -- blood gases
      (
        50800, 50801, 50802, 50803, 50804, 50805, 50806, 50807, 50808, 50809
        , 50810, 50811, 50812, 50813, 50814, 50815, 50816, 50817, 50818, 50819
        , 50820, 50821, 50822, 50823, 50824, 50825, 50826, 50827, 50828
        , 51545
      )
)
select pvt.SUBJECT_ID, pvt.HADM_ID, pvt.ICUSTAY_ID, pvt.CHARTTIME
, max(case when label = 'SPECIMEN' then value else null end) as specimen
, max(case when label = 'AADO2' then valuenum else null end) as aado2
, max(case when label = 'BASEEXCESS' then valuenum else null end) as baseexcess
, max(case when label = 'BICARBONATE' then valuenum else null end) as bicarbonate
, max(case when label = 'TOTALCO2' then valuenum else null end) as totalco2
, max(case when label = 'CARBOXYHEMOGLOBIN' then valuenum else null end) as carboxyhemoglobin
, max(case when label = 'CHLORIDE' then valuenum else null end) as chloride
, max(case when label = 'CALCIUM' then valuenum else null end) as calcium
, max(case when label = 'GLUCOSE' then valuenum else null end) as glucose
, max(case when label = 'HEMATOCRIT' then valuenum else null end) as hematocrit
, max(case when label = 'HEMOGLOBIN' then valuenum else null end) as hemoglobin
, max(case when label = 'INTUBATED' then valuenum else null end) as intubated
, max(case when label = 'LACTATE' then valuenum else null end) as lactate
, max(case when label = 'METHEMOGLOBIN' then valuenum else null end) as methemoglobin
, max(case when label = 'O2FLOW' then valuenum else null end) as o2flow
, max(case when label = 'FIO2' then valuenum else null end) as fio2
, max(case when label = 'SO2' then valuenum else null end) as so2 -- OXYGENSATURATION
, max(case when label = 'PCO2' then valuenum else null end) as pco2
, max(case when label = 'PEEP' then valuenum else null end) as peep
, max(case when label = 'PH' then valuenum else null end) as ph
, max(case when label = 'PO2' then valuenum else null end) as po2
, max(case when label = 'POTASSIUM' then valuenum else null end) as potassium
, max(case when label = 'REQUIREDO2' then valuenum else null end) as requiredo2
, max(case when label = 'SODIUM' then valuenum else null end) as sodium
, max(case when label = 'TEMPERATURE' then valuenum else null end) as temperature
, max(case when label = 'TIDALVOLUME' then valuenum else null end) as tidalvolume
, max(case when label = 'VENTILATIONRATE' then valuenum else null end) as ventilationrate
, max(case when label = 'VENTILATOR' then valuenum else null end) as ventilator
from pvt
group by pvt.subject_id, pvt.hadm_id, pvt.icustay_id, pvt.CHARTTIME
order by pvt.subject_id, pvt.hadm_id, pvt.icustay_id, pvt.CHARTTIME
  );",,,,,,,,,"dbt"
2022-07-29 16:00:30.409 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,9,"CREATE TABLE AS",2022-07-29 16:00:30 PDT,3/2131,1889,LOG,00000,"duration: 224.218 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.424 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,10,"idle in transaction",2022-07-29 16:00:30 PDT,3/2131,1889,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
alter table ""mimic"".""public"".""blood_gas_first_day"" rename to ""blood_gas_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:30.427 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,11,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2131,1889,LOG,00000,"duration: 2.911 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.434 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,12,"idle in transaction",2022-07-29 16:00:30 PDT,3/2131,1889,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
alter table ""mimic"".""public"".""blood_gas_first_day__dbt_tmp"" rename to ""blood_gas_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:30.434 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,13,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2131,1889,LOG,00000,"duration: 0.261 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.451 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,14,"idle in transaction",2022-07-29 16:00:30 PDT,3/2131,1889,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:30.455 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,15,"COMMIT",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 3.889 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.464 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,16,"idle",2022-07-29 16:00:30 PDT,3/2132,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
drop table if exists ""mimic"".""public"".""blood_gas_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:30.466 PDT,"ceci","mimic",64581,"localhost:51356",62e4668e.fc45,17,"DROP TABLE",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 1.949 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.504 PDT,,,64583,"localhost:51362",62e4668e.fc47,1,"",2022-07-29 16:00:30 PDT,,0,LOG,00000,"connection received: host=localhost port=51362",,,,,,,,,""
2022-07-29 16:00:30.510 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,2,"authentication",2022-07-29 16:00:30 PDT,3/2133,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:30.511 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,3,"idle",2022-07-29 16:00:30 PDT,3/2134,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.511 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,4,"BEGIN",2022-07-29 16:00:30 PDT,3/2134,0,LOG,00000,"duration: 0.109 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.512 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,5,"idle in transaction",2022-07-29 16:00:30 PDT,3/2134,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.512 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,6,"BEGIN",2022-07-29 16:00:30 PDT,3/2134,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.512 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,7,"BEGIN",2022-07-29 16:00:30 PDT,3/2134,0,LOG,00000,"duration: 0.033 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.513 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,8,"idle in transaction",2022-07-29 16:00:30 PDT,3/2134,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */


  create  table ""mimic"".""public"".""gcs_first_day__dbt_tmp""
  as (
    -- ITEMIDs used:

-- CAREVUE
--    723 as GCSVerbal
--    454 as GCSMotor
--    184 as GCSEyes

-- METAVISION
--    223900 GCS - Verbal Response
--    223901 GCS - Motor Response
--    220739 GCS - Eye Opening

-- The code combines the ITEMIDs into the carevue itemids, then pivots those
-- So 223900 is changed to 723, then the ITEMID 723 is pivoted to form GCSVerbal

-- Note:
--  The GCS for sedated patients is defaulted to 15 in this code.
--  This is in line with how the data is meant to be collected.
--  e.g., from the SAPS II publication:
--    For sedated patients, the Glasgow Coma Score before sedation was used.
--    This was ascertained either from interviewing the physician who ordered the sedation,
--    or by reviewing the patient's medical record.

with base as
(
  SELECT pvt.ICUSTAY_ID
  , pvt.charttime

  -- Easier names - note we coalesced Metavision and CareVue IDs below
  , max(case when pvt.itemid = 454 then pvt.valuenum else null end) as GCSMotor
  , max(case when pvt.itemid = 723 then pvt.valuenum else null end) as GCSVerbal
  , max(case when pvt.itemid = 184 then pvt.valuenum else null end) as GCSEyes

  -- If verbal was set to 0 in the below select, then this is an intubated patient
  , case
      when max(case when pvt.itemid = 723 then pvt.valuenum else null end) = 0
    then 1
    else 0
    end as EndoTrachFlag

  , ROW_NUMBER ()
          OVER (PARTITION BY pvt.ICUSTAY_ID ORDER BY pvt.charttime ASC) as rn

  FROM  (
  select l.ICUSTAY_ID
  -- merge the ITEMIDs so that the pivot applies to both metavision/carevue data
  , case
      when l.ITEMID in (723,223900) then 723
      when l.ITEMID in (454,223901) then 454
      when l.ITEMID in (184,220739) then 184
      else l.ITEMID end
    as ITEMID

  -- convert the data into a number, reserving a value of 0 for ET/Trach
  , case
      -- endotrach/vent is assigned a value of 0, later parsed specially
      when l.ITEMID = 723 and l.VALUE = '1.0 ET/Trach' then 0 -- carevue
      when l.ITEMID = 223900 and l.VALUE = 'No Response-ETT' then 0 -- metavision

      else VALUENUM
      end
    as VALUENUM
  , l.CHARTTIME
  FROM chartevents l

  -- get intime for charttime subselection
  inner join icustays b
    on l.icustay_id = b.icustay_id

  -- Isolate the desired GCS variables
  where l.ITEMID in
  (
    -- 198 -- GCS
    -- GCS components, CareVue
    184, 454, 723
    -- GCS components, Metavision
    , 223900, 223901, 220739
  )
  -- Only get data for the first 24 hours
  and l.charttime between b.intime and DATETIME_ADD(b.intime, INTERVAL '1' DAY)
  -- exclude rows marked as error
  AND (l.error IS NULL OR l.error = 0)
  ) pvt
  group by pvt.ICUSTAY_ID, pvt.charttime
)
, gcs as (
  select b.*
  , b2.GCSVerbal as GCSVerbalPrev
  , b2.GCSMotor as GCSMotorPrev
  , b2.GCSEyes as GCSEyesPrev
  -- Calculate GCS, factoring in special case when they are intubated and prev vals
  -- note that the coalesce are used to implement the following if:
  --  if current value exists, use it
  --  if previous value exists, use it
  --  otherwise, default to normal
  , case
      -- replace GCS during sedation with 15
      when b.GCSVerbal = 0
        then 15
      when b.GCSVerbal is null and b2.GCSVerbal = 0
        then 15
      -- if previously they were intub, but they aren't now, do not use previous GCS values
      when b2.GCSVerbal = 0
        then
            coalesce(b.GCSMotor,6)
          + coalesce(b.GCSVerbal,5)
          + coalesce(b.GCSEyes,4)
      -- otherwise, add up score normally, imputing previous value if none available at current time
      else
            coalesce(b.GCSMotor,coalesce(b2.GCSMotor,6))
          + coalesce(b.GCSVerbal,coalesce(b2.GCSVerbal,5))
          + coalesce(b.GCSEyes,coalesce(b2.GCSEyes,4))
      end as GCS

  from base b
  -- join to itself within 6 hours to get previous value
  left join base b2
    on b.ICUSTAY_ID = b2.ICUSTAY_ID and b.rn = b2.rn+1 and b2.charttime > DATETIME_SUB(b.charttime, INTERVAL '6' HOUR)
)
, gcs_final as (
  select gcs.*
  -- This sorts the data by GCS, so rn=1 is the the lowest GCS values to keep
  , ROW_NUMBER ()
          OVER (PARTITION BY gcs.ICUSTAY_ID
                ORDER BY gcs.GCS
               ) as IsMinGCS
  from gcs
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
-- The minimum GCS is determined by the above row partition, we only join if IsMinGCS=1
, GCS as mingcs
, coalesce(GCSMotor,GCSMotorPrev) as gcsmotor
, coalesce(GCSVerbal,GCSVerbalPrev) as gcsverbal
, coalesce(GCSEyes,GCSEyesPrev) as gcseyes
, EndoTrachFlag as endotrachflag

-- subselect down to the cohort of eligible patients
FROM icustays ie
left join gcs_final gs
  on ie.icustay_id = gs.icustay_id and gs.IsMinGCS = 1
ORDER BY ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:30.649 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,9,"CREATE TABLE AS",2022-07-29 16:00:30 PDT,3/2134,1891,LOG,00000,"duration: 136.414 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.656 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,10,"idle in transaction",2022-07-29 16:00:30 PDT,3/2134,1891,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
alter table ""mimic"".""public"".""gcs_first_day"" rename to ""gcs_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:30.656 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,11,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2134,1891,LOG,00000,"duration: 0.322 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.663 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,12,"idle in transaction",2022-07-29 16:00:30 PDT,3/2134,1891,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
alter table ""mimic"".""public"".""gcs_first_day__dbt_tmp"" rename to ""gcs_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:30.663 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,13,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2134,1891,LOG,00000,"duration: 0.311 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.669 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,14,"idle in transaction",2022-07-29 16:00:30 PDT,3/2134,1891,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:30.675 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,15,"COMMIT",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 5.440 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.679 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,16,"idle",2022-07-29 16:00:30 PDT,3/2135,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
drop table if exists ""mimic"".""public"".""gcs_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:30.680 PDT,"ceci","mimic",64583,"localhost:51362",62e4668e.fc47,17,"DROP TABLE",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 1.261 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.713 PDT,,,64584,"localhost:51364",62e4668e.fc48,1,"",2022-07-29 16:00:30 PDT,,0,LOG,00000,"connection received: host=localhost port=51364",,,,,,,,,""
2022-07-29 16:00:30.716 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,2,"authentication",2022-07-29 16:00:30 PDT,3/2136,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:30.717 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,3,"idle",2022-07-29 16:00:30 PDT,3/2137,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.717 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,4,"BEGIN",2022-07-29 16:00:30 PDT,3/2137,0,LOG,00000,"duration: 0.141 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.718 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,5,"idle in transaction",2022-07-29 16:00:30 PDT,3/2137,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.718 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,6,"BEGIN",2022-07-29 16:00:30 PDT,3/2137,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.718 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,7,"BEGIN",2022-07-29 16:00:30 PDT,3/2137,0,LOG,00000,"duration: 0.124 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.719 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,8,"idle in transaction",2022-07-29 16:00:30 PDT,3/2137,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */


  create  table ""mimic"".""public"".""height_first_day__dbt_tmp""
  as (
    -- This query extracts heights for adult ICU patients.
-- It uses all information from the patient's first ICU day.
-- This is done for consistency with other queries - it's not necessarily needed.
-- Height is unlikely to change throughout a patient's stay.

-- ** Requires the echodata view, generated by concepts/echo-data.sql

-- staging table to ensure all heights are in centimeters
with ce0 as
(
    SELECT
      c.icustay_id
      , case
        -- convert inches to centimetres
          when itemid in (920, 1394, 4187, 3486)
              then valuenum * 2.54
            else valuenum
        end as Height
    FROM chartevents c
    inner join icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (226730,920, 1394, 4187, 3486,3485,4188) -- height
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
)
, ce as
(
    SELECT
        icustay_id
        -- extract the median height from the chart to add robustness against outliers
        , AVG(height) as Height_chart
    from ce0
    where height > 100
    group by icustay_id
)
-- requires the echo-data.sql query to run
-- this adds heights from the free-text echo notes
, echo as
(
    select
        ec.subject_id
        -- all echo heights are in inches
        , 2.54*AVG(height) as Height_Echo
    from ""mimic"".""public"".""echo_data"" ec
    inner join icustays ie
        on ec.subject_id = ie.subject_id
        and ec.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    where height is not null
    and height*2.54 > 100
    group by ec.subject_id
)
select
    ie.icustay_id
    , coalesce(ce.Height_chart, ec.Height_Echo) as height

    -- components
    , ce.height_chart
    , ec.height_echo
FROM icustays ie

-- filter to only adults
inner join patients pat
    on ie.subject_id = pat.subject_id
    and ie.intime > DATETIME_ADD(pat.dob, INTERVAL '1' YEAR)

left join ce
    on ie.icustay_id = ce.icustay_id

left join echo ec
    on ie.subject_id = ec.subject_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:30.875 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,9,"CREATE TABLE AS",2022-07-29 16:00:30 PDT,3/2137,1893,LOG,00000,"duration: 155.609 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.881 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,10,"idle in transaction",2022-07-29 16:00:30 PDT,3/2137,1893,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
alter table ""mimic"".""public"".""height_first_day"" rename to ""height_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:30.882 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,11,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2137,1893,LOG,00000,"duration: 0.638 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.887 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,12,"idle in transaction",2022-07-29 16:00:30 PDT,3/2137,1893,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
alter table ""mimic"".""public"".""height_first_day__dbt_tmp"" rename to ""height_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:30.887 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,13,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2137,1893,LOG,00000,"duration: 0.265 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.894 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,14,"idle in transaction",2022-07-29 16:00:30 PDT,3/2137,1893,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:30.898 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,15,"COMMIT",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 4.261 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.901 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,16,"idle",2022-07-29 16:00:30 PDT,3/2138,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
drop table if exists ""mimic"".""public"".""height_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:30.903 PDT,"ceci","mimic",64584,"localhost:51364",62e4668e.fc48,17,"DROP TABLE",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 1.830 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.932 PDT,,,64585,"localhost:51366",62e4668e.fc49,1,"",2022-07-29 16:00:30 PDT,,0,LOG,00000,"connection received: host=localhost port=51366",,,,,,,,,""
2022-07-29 16:00:30.935 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,2,"authentication",2022-07-29 16:00:30 PDT,3/2139,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:30.936 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,3,"idle",2022-07-29 16:00:30 PDT,3/2140,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.936 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,4,"BEGIN",2022-07-29 16:00:30 PDT,3/2140,0,LOG,00000,"duration: 0.082 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.936 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,5,"idle in transaction",2022-07-29 16:00:30 PDT,3/2140,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:30.936 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,6,"BEGIN",2022-07-29 16:00:30 PDT,3/2140,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:30.936 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,7,"BEGIN",2022-07-29 16:00:30 PDT,3/2140,0,LOG,00000,"duration: 0.023 ms",,,,,,,,,"dbt"
2022-07-29 16:00:30.937 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,8,"idle in transaction",2022-07-29 16:00:30 PDT,3/2140,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */


  create  table ""mimic"".""public"".""labs_first_day__dbt_tmp""
  as (
    -- This query pivots lab values taken in the first 24 hours of a patient's stay

-- Have already confirmed that the unit of measurement is always the same: null or the correct unit

SELECT
  pvt.subject_id, pvt.hadm_id, pvt.icustay_id

  , min(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE NULL END) AS aniongap_min
  , max(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE NULL END) AS aniongap_max
  , min(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE NULL END) AS albumin_min
  , max(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE NULL END) AS albumin_max
  , min(CASE WHEN label = 'BANDS' THEN valuenum ELSE NULL END) AS bands_min
  , max(CASE WHEN label = 'BANDS' THEN valuenum ELSE NULL END) AS bands_max
  , min(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE NULL END) AS bicarbonate_min
  , max(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE NULL END) AS bicarbonate_max
  , min(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE NULL END) AS bilirubin_min
  , max(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE NULL END) AS bilirubin_max
  , min(CASE WHEN label = 'CREATININE' THEN valuenum ELSE NULL END) AS creatinine_min
  , max(CASE WHEN label = 'CREATININE' THEN valuenum ELSE NULL END) AS creatinine_max
  , min(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE NULL END) AS chloride_min
  , max(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE NULL END) AS chloride_max
  , min(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE NULL END) AS glucose_min
  , max(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE NULL END) AS glucose_max
  , min(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE NULL END) AS hematocrit_min
  , max(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE NULL END) AS hematocrit_max
  , min(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE NULL END) AS hemoglobin_min
  , max(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE NULL END) AS hemoglobin_max
  , min(CASE WHEN label = 'LACTATE' THEN valuenum ELSE NULL END) AS lactate_min
  , max(CASE WHEN label = 'LACTATE' THEN valuenum ELSE NULL END) AS lactate_max
  , min(CASE WHEN label = 'PLATELET' THEN valuenum ELSE NULL END) AS platelet_min
  , max(CASE WHEN label = 'PLATELET' THEN valuenum ELSE NULL END) AS platelet_max
  , min(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE NULL END) AS potassium_min
  , max(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE NULL END) AS potassium_max
  , min(CASE WHEN label = 'PTT' THEN valuenum ELSE NULL END) AS ptt_min
  , max(CASE WHEN label = 'PTT' THEN valuenum ELSE NULL END) AS ptt_max
  , min(CASE WHEN label = 'INR' THEN valuenum ELSE NULL END) AS inr_min
  , max(CASE WHEN label = 'INR' THEN valuenum ELSE NULL END) AS inr_max
  , min(CASE WHEN label = 'PT' THEN valuenum ELSE NULL END) AS pt_min
  , max(CASE WHEN label = 'PT' THEN valuenum ELSE NULL END) AS pt_max
  , min(CASE WHEN label = 'SODIUM' THEN valuenum ELSE NULL END) AS sodium_min
  , max(CASE WHEN label = 'SODIUM' THEN valuenum ELSE NULL END) AS sodium_max
  , min(CASE WHEN label = 'BUN' THEN valuenum ELSE NULL END) AS bun_min
  , max(CASE WHEN label = 'BUN' THEN valuenum ELSE NULL END) AS bun_max
  , min(CASE WHEN label = 'WBC' THEN valuenum ELSE NULL END) AS wbc_min
  , max(CASE WHEN label = 'WBC' THEN valuenum ELSE NULL END) AS wbc_max


FROM
( -- begin query that extracts the data
  SELECT ie.subject_id, ie.hadm_id, ie.icustay_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
  , CASE
        WHEN itemid = 50868 THEN 'ANION GAP'
        WHEN itemid = 50862 THEN 'ALBUMIN'
        WHEN itemid = 51144 THEN 'BANDS'
        WHEN itemid = 50882 THEN 'BICARBONATE'
        WHEN itemid = 50885 THEN 'BILIRUBIN'
        WHEN itemid = 50912 THEN 'CREATININE'
        WHEN itemid = 50806 THEN 'CHLORIDE'
        WHEN itemid = 50902 THEN 'CHLORIDE'
        WHEN itemid = 50809 THEN 'GLUCOSE'
        WHEN itemid = 50931 THEN 'GLUCOSE'
        WHEN itemid = 50810 THEN 'HEMATOCRIT'
        WHEN itemid = 51221 THEN 'HEMATOCRIT'
        WHEN itemid = 50811 THEN 'HEMOGLOBIN'
        WHEN itemid = 51222 THEN 'HEMOGLOBIN'
        WHEN itemid = 50813 THEN 'LACTATE'
        WHEN itemid = 51265 THEN 'PLATELET'
        WHEN itemid = 50822 THEN 'POTASSIUM'
        WHEN itemid = 50971 THEN 'POTASSIUM'
        WHEN itemid = 51275 THEN 'PTT'
        WHEN itemid = 51237 THEN 'INR'
        WHEN itemid = 51274 THEN 'PT'
        WHEN itemid = 50824 THEN 'SODIUM'
        WHEN itemid = 50983 THEN 'SODIUM'
        WHEN itemid = 51006 THEN 'BUN'
        WHEN itemid = 51300 THEN 'WBC'
        WHEN itemid = 51301 THEN 'WBC'
      ELSE null
    END as label
  , -- add in some sanity checks on the values
  -- the where clause below requires all valuenum to be > 0, so these are only upper limit checks
    CASE
      WHEN itemid = 50862 and valuenum >    10 THEN null -- g/dL 'ALBUMIN'
      WHEN itemid = 50868 and valuenum > 10000 THEN null -- mEq/L 'ANION GAP'
      WHEN itemid = 51144 and valuenum <     0 THEN null -- immature band forms, %
      WHEN itemid = 51144 and valuenum >   100 THEN null -- immature band forms, %
      WHEN itemid = 50882 and valuenum > 10000 THEN null -- mEq/L 'BICARBONATE'
      WHEN itemid = 50885 and valuenum >   150 THEN null -- mg/dL 'BILIRUBIN'
      WHEN itemid = 50806 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50902 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50912 and valuenum >   150 THEN null -- mg/dL 'CREATININE'
      WHEN itemid = 50809 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50931 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50810 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 51221 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 50811 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 51222 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 50813 and valuenum >    50 THEN null -- mmol/L 'LACTATE'
      WHEN itemid = 51265 and valuenum > 10000 THEN null -- K/uL 'PLATELET'
      WHEN itemid = 50822 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 50971 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 51275 and valuenum >   150 THEN null -- sec 'PTT'
      WHEN itemid = 51237 and valuenum >    50 THEN null -- 'INR'
      WHEN itemid = 51274 and valuenum >   150 THEN null -- sec 'PT'
      WHEN itemid = 50824 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 50983 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 51006 and valuenum >   300 THEN null -- 'BUN'
      WHEN itemid = 51300 and valuenum >  1000 THEN null -- 'WBC'
      WHEN itemid = 51301 and valuenum >  1000 THEN null -- 'WBC'
    ELSE le.valuenum
    END as valuenum

  FROM icustays ie

  LEFT JOIN labevents le
    ON le.subject_id = ie.subject_id AND le.hadm_id = ie.hadm_id
    AND le.charttime BETWEEN (DATETIME_SUB(ie.intime, INTERVAL '6' HOUR)) AND (DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
    AND le.ITEMID in
    (
      -- comment is: LABEL | CATEGORY | FLUID | NUMBER OF ROWS IN LABEVENTS
      50868, -- ANION GAP | CHEMISTRY | BLOOD | 769895
      50862, -- ALBUMIN | CHEMISTRY | BLOOD | 146697
      51144, -- BANDS - hematology
      50882, -- BICARBONATE | CHEMISTRY | BLOOD | 780733
      50885, -- BILIRUBIN, TOTAL | CHEMISTRY | BLOOD | 238277
      50912, -- CREATININE | CHEMISTRY | BLOOD | 797476
      50902, -- CHLORIDE | CHEMISTRY | BLOOD | 795568
      50806, -- CHLORIDE, WHOLE BLOOD | BLOOD GAS | BLOOD | 48187
      50931, -- GLUCOSE | CHEMISTRY | BLOOD | 748981
      50809, -- GLUCOSE | BLOOD GAS | BLOOD | 196734
      51221, -- HEMATOCRIT | HEMATOLOGY | BLOOD | 881846
      50810, -- HEMATOCRIT, CALCULATED | BLOOD GAS | BLOOD | 89715
      51222, -- HEMOGLOBIN | HEMATOLOGY | BLOOD | 752523
      50811, -- HEMOGLOBIN | BLOOD GAS | BLOOD | 89712
      50813, -- LACTATE | BLOOD GAS | BLOOD | 187124
      51265, -- PLATELET COUNT | HEMATOLOGY | BLOOD | 778444
      50971, -- POTASSIUM | CHEMISTRY | BLOOD | 845825
      50822, -- POTASSIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 192946
      51275, -- PTT | HEMATOLOGY | BLOOD | 474937
      51237, -- INR(PT) | HEMATOLOGY | BLOOD | 471183
      51274, -- PT | HEMATOLOGY | BLOOD | 469090
      50983, -- SODIUM | CHEMISTRY | BLOOD | 808489
      50824, -- SODIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 71503
      51006, -- UREA NITROGEN | CHEMISTRY | BLOOD | 791925
      51301, -- WHITE BLOOD CELLS | HEMATOLOGY | BLOOD | 753301
      51300  -- WBC COUNT | HEMATOLOGY | BLOOD | 2371
    )
    AND valuenum IS NOT null AND valuenum > 0 -- lab values cannot be 0 and cannot be negative
) pvt
GROUP BY pvt.subject_id, pvt.hadm_id, pvt.icustay_id
ORDER BY pvt.subject_id, pvt.hadm_id, pvt.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:32.543 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,9,"CREATE TABLE AS",2022-07-29 16:00:30 PDT,3/2140,1895,LOG,00000,"duration: 1606.300 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.552 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,10,"idle in transaction",2022-07-29 16:00:30 PDT,3/2140,1895,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
alter table ""mimic"".""public"".""labs_first_day"" rename to ""labs_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:32.552 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,11,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2140,1895,LOG,00000,"duration: 0.313 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.558 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,12,"idle in transaction",2022-07-29 16:00:30 PDT,3/2140,1895,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
alter table ""mimic"".""public"".""labs_first_day__dbt_tmp"" rename to ""labs_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:32.559 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,13,"ALTER TABLE",2022-07-29 16:00:30 PDT,3/2140,1895,LOG,00000,"duration: 0.255 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.563 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,14,"idle in transaction",2022-07-29 16:00:30 PDT,3/2140,1895,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:32.567 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,15,"COMMIT",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 3.708 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.570 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,16,"idle",2022-07-29 16:00:30 PDT,3/2141,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
drop table if exists ""mimic"".""public"".""labs_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:32.576 PDT,"ceci","mimic",64585,"localhost:51366",62e4668e.fc49,17,"DROP TABLE",2022-07-29 16:00:30 PDT,3/0,0,LOG,00000,"duration: 5.997 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.605 PDT,,,64605,"localhost:51372",62e46690.fc5d,1,"",2022-07-29 16:00:32 PDT,,0,LOG,00000,"connection received: host=localhost port=51372",,,,,,,,,""
2022-07-29 16:00:32.609 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,2,"authentication",2022-07-29 16:00:32 PDT,3/2142,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:32.610 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,3,"idle",2022-07-29 16:00:32 PDT,3/2143,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:32.610 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,4,"BEGIN",2022-07-29 16:00:32 PDT,3/2143,0,LOG,00000,"duration: 0.103 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.611 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,5,"idle in transaction",2022-07-29 16:00:32 PDT,3/2143,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:32.611 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,6,"BEGIN",2022-07-29 16:00:32 PDT,3/2143,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:32.611 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,7,"BEGIN",2022-07-29 16:00:32 PDT,3/2143,0,LOG,00000,"duration: 0.123 ms",,,,,,,,,"dbt"
2022-07-29 16:00:32.612 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,8,"idle in transaction",2022-07-29 16:00:32 PDT,3/2143,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */


  create  table ""mimic"".""public"".""rrt_first_day__dbt_tmp""
  as (
    -- determines if patients received any dialysis during their stay

-- Some example aggregate queries which summarize the data here..
-- This query estimates 6.7% of ICU patients received RRT.
    -- select count(rrt.icustay_id) as numobs
    -- , sum(rrt) as numrrt
    -- , sum(case when rrt=1 then 1 else 0 end)*100.0 / count(rrt.icustay_id)
    -- as percent_rrt
    -- from rrt
    -- inner join icustays ie on rrt.icustay_id = ie.icustay_id
    -- inner join patients p
    -- on rrt.subject_id = p.subject_id
    -- and p.dob < ie.intime - interval '1' year
    -- inner join admissions adm
    -- on rrt.hadm_id = adm.hadm_id

-- This query estimates that 4.6% of first ICU stays received RRT.
    -- select
    --   count(rrt.icustay_id) as numobs
    --   , sum(rrt) as numrrt
    --   , sum(case when rrt=1 then 1 else 0 end)*100.0 / count(rrt.icustay_id)
    -- as percent_rrt
    -- from
    -- (
    -- select ie.icustay_id, rrt.rrt
    --   , ROW_NUMBER() over (partition by ie.subject_id order by ie.intime) rn
    -- from rrt
    -- inner join icustays ie
    --   on rrt.icustay_id = ie.icustay_id
    -- inner join patients p
    --   on rrt.subject_id = p.subject_id
    -- and p.dob < ie.intime - interval '1' year
    -- inner join admissions adm
    --   on rrt.hadm_id = adm.hadm_id
    -- ) rrt
    -- where rn = 1

with cv as
(
  select ie.icustay_id
    , max(
        case
          when ce.itemid in (152,148,149,146,147,151,150) and value is not null then 1
          when ce.itemid in (229,235,241,247,253,259,265,271) and value = 'Dialysis Line' then 1
          when ce.itemid = 582 and value in ('CAVH Start','CAVH D/C','CVVHD Start','CVVHD D/C','Hemodialysis st','Hemodialysis end') then 1
        else 0 end
        ) as RRT
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.itemid in
    (
       152 -- ""Dialysis Type""61449
      ,148 -- ""Dialysis Access Site""60335
      ,149 -- ""Dialysis Access Type""60030
      ,146 -- ""Dialysate Flow ml/hr""57445
      ,147 -- ""Dialysate Infusing""56605
      ,151 -- ""Dialysis Site Appear""37345
      ,150 -- ""Dialysis Machine""27472
      ,229 -- INV Line#1 [Type]
      ,235 -- INV Line#2 [Type]
      ,241 -- INV Line#3 [Type]
      ,247 -- INV Line#4 [Type]
      ,253 -- INV Line#5 [Type]
      ,259 -- INV Line#6 [Type]
      ,265 -- INV Line#7 [Type]
      ,271 -- INV Line#8 [Type]
      ,582 -- Procedures
    )
    and ce.value is not null
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where ie.dbsource = 'carevue'
  group by ie.icustay_id
)
, mv_ce as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
      -- Checkboxes
        226118 -- | Dialysis Catheter placed in outside facility      | Access Lines - Invasive | chartevents        | Checkbox
      , 227357 -- | Dialysis Catheter Dressing Occlusive              | Access Lines - Invasive | chartevents        | Checkbox
      , 225725 -- | Dialysis Catheter Tip Cultured                    | Access Lines - Invasive | chartevents        | Checkbox
      -- Numeric values
      , 226499 -- | Hemodialysis Output                               | Dialysis                | chartevents        | Numeric
      , 224154 -- | Dialysate Rate                                    | Dialysis                | chartevents        | Numeric
      , 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis                | chartevents        | Numeric
      , 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis                | chartevents        | Numeric
      , 225183 -- | Current Goal                     | Dialysis | chartevents        | Numeric
      , 227438 -- | Volume not removed               | Dialysis | chartevents        | Numeric
      , 224191 -- | Hourly Patient Fluid Removal     | Dialysis | chartevents        | Numeric
      , 225806 -- | Volume In (PD)                   | Dialysis | chartevents        | Numeric
      , 225807 -- | Volume Out (PD)                  | Dialysis | chartevents        | Numeric
      , 228004 -- | Citrate (ACD-A)                  | Dialysis | chartevents        | Numeric
      , 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis | chartevents        | Numeric
      , 228006 -- | Post Filter Replacement Rate     | Dialysis | chartevents        | Numeric
      , 224144 -- | Blood Flow (ml/min)              | Dialysis | chartevents        | Numeric
      , 224145 -- | Heparin Dose (per hour)          | Dialysis | chartevents        | Numeric
      , 224149 -- | Access Pressure                  | Dialysis | chartevents        | Numeric
      , 224150 -- | Filter Pressure                  | Dialysis | chartevents        | Numeric
      , 224151 -- | Effluent Pressure                | Dialysis | chartevents        | Numeric
      , 224152 -- | Return Pressure                  | Dialysis | chartevents        | Numeric
      , 224153 -- | Replacement Rate                 | Dialysis | chartevents        | Numeric
      , 224404 -- | ART Lumen Volume                 | Dialysis | chartevents        | Numeric
      , 224406 -- | VEN Lumen Volume                 | Dialysis | chartevents        | Numeric
      , 226457 -- | Ultrafiltrate Output             | Dialysis | chartevents        | Numeric
    )
    and valuenum > 0 -- also ensures it's not null
  group by ie.icustay_id
)
, mv_ie as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join inputevents_mv tt
    on ie.icustay_id = tt.icustay_id
    and tt.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
        227536 --	KCl (CRRT)	Medications	inputevents_mv	Solution
      , 227525 --	Calcium Gluconate (CRRT)	Medications	inputevents_mv	Solution
    )
    and amount > 0 -- also ensures it's not null
  group by ie.icustay_id
)
, mv_de as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join datetimeevents tt
    on ie.icustay_id = tt.icustay_id
    and tt.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
      -- TODO: unsure how to handle ""Last dialysis""
      --  225128 -- | Last dialysis                                     | Adm History/FHPA        | datetimeevents     | Date time
        225318 -- | Dialysis Catheter Cap Change                      | Access Lines - Invasive | datetimeevents     | Date time
      , 225319 -- | Dialysis Catheter Change over Wire Date           | Access Lines - Invasive | datetimeevents     | Date time
      , 225321 -- | Dialysis Catheter Dressing Change                 | Access Lines - Invasive | datetimeevents     | Date time
      , 225322 -- | Dialysis Catheter Insertion Date                  | Access Lines - Invasive | datetimeevents     | Date time
      , 225324 -- | Dialysis CatheterTubing Change                    | Access Lines - Invasive | datetimeevents     | Date time
    )
  group by ie.icustay_id
)
, mv_pe as
(
    select ie.icustay_id
      , 1 as RRT
    FROM icustays ie
    inner join procedureevents_mv tt
      on ie.icustay_id = tt.icustay_id
      and tt.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
      and itemid in
      (
          225441 -- | Hemodialysis                                      | 4-Procedures            | procedureevents_mv | Process
        , 225802 -- | Dialysis - CRRT                                   | Dialysis                | procedureevents_mv | Process
        , 225803 -- | Dialysis - CVVHD                                  | Dialysis                | procedureevents_mv | Process
        , 225805 -- | Peritoneal Dialysis                               | Dialysis                | procedureevents_mv | Process
        , 224270 -- | Dialysis Catheter                                 | Access Lines - Invasive | procedureevents_mv | Process
        , 225809 -- | Dialysis - CVVHDF                                 | Dialysis                | procedureevents_mv | Process
        , 225955 -- | Dialysis - SCUF                                   | Dialysis                | procedureevents_mv | Process
        , 225436 -- | CRRT Filter Change               | Dialysis | procedureevents_mv | Process
      )
    group by ie.icustay_id
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
  , case
      when cv.RRT = 1 then 1
      when mv_ce.RRT = 1 then 1
      when mv_ie.RRT = 1 then 1
      when mv_de.RRT = 1 then 1
      when mv_pe.RRT = 1 then 1
      else 0
    end as rrt
FROM icustays ie
left join cv
  on ie.icustay_id = cv.icustay_id
left join mv_ce
  on ie.icustay_id = mv_ce.icustay_id
left join mv_ie
  on ie.icustay_id = mv_ie.icustay_id
left join mv_de
  on ie.icustay_id = mv_de.icustay_id
left join mv_pe
  on ie.icustay_id = mv_pe.icustay_id
order by ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:34.325 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,9,"CREATE TABLE AS",2022-07-29 16:00:32 PDT,3/2143,1897,LOG,00000,"duration: 1712.931 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.332 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,10,"idle in transaction",2022-07-29 16:00:32 PDT,3/2143,1897,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
alter table ""mimic"".""public"".""rrt_first_day"" rename to ""rrt_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:34.332 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,11,"ALTER TABLE",2022-07-29 16:00:32 PDT,3/2143,1897,LOG,00000,"duration: 0.371 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.339 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,12,"idle in transaction",2022-07-29 16:00:32 PDT,3/2143,1897,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
alter table ""mimic"".""public"".""rrt_first_day__dbt_tmp"" rename to ""rrt_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:34.340 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,13,"ALTER TABLE",2022-07-29 16:00:32 PDT,3/2143,1897,LOG,00000,"duration: 0.232 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.344 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,14,"idle in transaction",2022-07-29 16:00:32 PDT,3/2143,1897,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:34.349 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,15,"COMMIT",2022-07-29 16:00:32 PDT,3/0,0,LOG,00000,"duration: 5.795 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.354 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,16,"idle",2022-07-29 16:00:32 PDT,3/2144,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
drop table if exists ""mimic"".""public"".""rrt_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:34.355 PDT,"ceci","mimic",64605,"localhost:51372",62e46690.fc5d,17,"DROP TABLE",2022-07-29 16:00:32 PDT,3/0,0,LOG,00000,"duration: 1.139 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.380 PDT,,,64615,"localhost:51378",62e46692.fc67,1,"",2022-07-29 16:00:34 PDT,,0,LOG,00000,"connection received: host=localhost port=51378",,,,,,,,,""
2022-07-29 16:00:34.385 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,2,"authentication",2022-07-29 16:00:34 PDT,3/2145,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:34.387 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,3,"idle",2022-07-29 16:00:34 PDT,3/2146,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:34.387 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,4,"BEGIN",2022-07-29 16:00:34 PDT,3/2146,0,LOG,00000,"duration: 0.119 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.387 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,5,"idle in transaction",2022-07-29 16:00:34 PDT,3/2146,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:34.387 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,6,"BEGIN",2022-07-29 16:00:34 PDT,3/2146,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:34.387 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,7,"BEGIN",2022-07-29 16:00:34 PDT,3/2146,0,LOG,00000,"duration: 0.138 ms",,,,,,,,,"dbt"
2022-07-29 16:00:34.390 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,8,"idle in transaction",2022-07-29 16:00:34 PDT,3/2146,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */


  create  table ""mimic"".""public"".""urine_output_first_day__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Purpose: Create a view of the urine output for each ICUSTAY_ID over the first 24 hours.
-- ------------------------------------------------------------------

select
  -- patient identifiers
  ie.subject_id, ie.hadm_id, ie.icustay_id

  -- volumes associated with urine output ITEMIDs
  , sum(
      -- we consider input of GU irrigant as a negative volume
      case
        when oe.itemid = 227488 and oe.value > 0 then -1*oe.value
        else oe.value
    end) as urineoutput
FROM icustays ie
-- Join to the outputevents table to get urine output
left join outputevents oe
-- join on all patient identifiers
on ie.subject_id = oe.subject_id and ie.hadm_id = oe.hadm_id and ie.icustay_id = oe.icustay_id
-- and ensure the data occurs during the first day
and oe.charttime between ie.intime and (DATETIME_ADD(ie.intime, INTERVAL '1' DAY)) -- first ICU day
where itemid in
(
-- these are the most frequently occurring urine output observations in CareVue
40055, -- ""Urine Out Foley""
43175, -- ""Urine .""
40069, -- ""Urine Out Void""
40094, -- ""Urine Out Condom Cath""
40715, -- ""Urine Out Suprapubic""
40473, -- ""Urine Out IleoConduit""
40085, -- ""Urine Out Incontinent""
40057, -- ""Urine Out Rt Nephrostomy""
40056, -- ""Urine Out Lt Nephrostomy""
40405, -- ""Urine Out Other""
40428, -- ""Urine Out Straight Cath""
40086,--	Urine Out Incontinent
40096, -- ""Urine Out Ureteral Stent #1""
40651, -- ""Urine Out Ureteral Stent #2""

-- these are the most frequently occurring urine output observations in MetaVision
226559, -- ""Foley""
226560, -- ""Void""
226561, -- ""Condom Cath""
226584, -- ""Ileoconduit""
226563, -- ""Suprapubic""
226564, -- ""R Nephrostomy""
226565, -- ""L Nephrostomy""
226567, --	Straight Cath
226557, -- R Ureteral Stent
226558, -- L Ureteral Stent
227488, -- GU Irrigant Volume In
227489  -- GU Irrigant/Urine Volume Out
)
group by ie.subject_id, ie.hadm_id, ie.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:38.124 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,9,"CREATE TABLE AS",2022-07-29 16:00:34 PDT,3/2146,1899,LOG,00000,"duration: 3734.794 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.134 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,10,"idle in transaction",2022-07-29 16:00:34 PDT,3/2146,1899,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
alter table ""mimic"".""public"".""urine_output_first_day"" rename to ""urine_output_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:38.134 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,11,"ALTER TABLE",2022-07-29 16:00:34 PDT,3/2146,1899,LOG,00000,"duration: 0.415 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.140 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,12,"idle in transaction",2022-07-29 16:00:34 PDT,3/2146,1899,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
alter table ""mimic"".""public"".""urine_output_first_day__dbt_tmp"" rename to ""urine_output_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:38.140 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,13,"ALTER TABLE",2022-07-29 16:00:34 PDT,3/2146,1899,LOG,00000,"duration: 0.285 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.144 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,14,"idle in transaction",2022-07-29 16:00:34 PDT,3/2146,1899,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:38.152 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,15,"COMMIT",2022-07-29 16:00:34 PDT,3/0,0,LOG,00000,"duration: 7.987 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.156 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,16,"idle",2022-07-29 16:00:34 PDT,3/2147,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
drop table if exists ""mimic"".""public"".""urine_output_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:38.157 PDT,"ceci","mimic",64615,"localhost:51378",62e46692.fc67,17,"DROP TABLE",2022-07-29 16:00:34 PDT,3/0,0,LOG,00000,"duration: 1.219 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.186 PDT,,,64637,"localhost:51386",62e46696.fc7d,1,"",2022-07-29 16:00:38 PDT,,0,LOG,00000,"connection received: host=localhost port=51386",,,,,,,,,""
2022-07-29 16:00:38.190 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,2,"authentication",2022-07-29 16:00:38 PDT,3/2148,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:38.191 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,3,"idle",2022-07-29 16:00:38 PDT,3/2149,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.191 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,4,"BEGIN",2022-07-29 16:00:38 PDT,3/2149,0,LOG,00000,"duration: 0.102 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.191 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,5,"idle in transaction",2022-07-29 16:00:38 PDT,3/2149,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.191 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,6,"BEGIN",2022-07-29 16:00:38 PDT,3/2149,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:38.191 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,7,"BEGIN",2022-07-29 16:00:38 PDT,3/2149,0,LOG,00000,"duration: 0.093 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.193 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,8,"idle in transaction",2022-07-29 16:00:38 PDT,3/2149,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */


  create  table ""mimic"".""public"".""ventilation_first_day__dbt_tmp""
  as (
    -- Determines if a patient is ventilated on the first day of their ICU stay.
-- Creates a table with the result.
-- Requires the ventilation_durations table, generated by ../ventilation-durations.sql

select
  ie.subject_id, ie.hadm_id, ie.icustay_id
  -- if vd.icustay_id is not null, then they have a valid ventilation event
  -- in this case, we say they are ventilated
  -- otherwise, they are not
  , max(case
      when vd.icustay_id is not null then 1
    else 0 end) as vent
FROM icustays ie
left join ""mimic"".""public"".""ventilation_durations"" vd
  on ie.icustay_id = vd.icustay_id
  and
  (
    -- ventilation duration overlaps with ICU admission -> vented on admission
    (vd.starttime <= ie.intime and vd.endtime >= ie.intime)
    -- ventilation started during the first day
    OR (vd.starttime >= ie.intime and vd.starttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
  )
group by ie.subject_id, ie.hadm_id, ie.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:38.342 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,9,"CREATE TABLE AS",2022-07-29 16:00:38 PDT,3/2149,1901,LOG,00000,"duration: 149.162 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.349 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,10,"idle in transaction",2022-07-29 16:00:38 PDT,3/2149,1901,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
alter table ""mimic"".""public"".""ventilation_first_day"" rename to ""ventilation_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:38.350 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,11,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2149,1901,LOG,00000,"duration: 0.438 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.358 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,12,"idle in transaction",2022-07-29 16:00:38 PDT,3/2149,1901,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
alter table ""mimic"".""public"".""ventilation_first_day__dbt_tmp"" rename to ""ventilation_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:38.358 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,13,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2149,1901,LOG,00000,"duration: 0.334 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.364 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,14,"idle in transaction",2022-07-29 16:00:38 PDT,3/2149,1901,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:38.370 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,15,"COMMIT",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 5.794 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.376 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,16,"idle",2022-07-29 16:00:38 PDT,3/2150,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
drop table if exists ""mimic"".""public"".""ventilation_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:38.382 PDT,"ceci","mimic",64637,"localhost:51386",62e46696.fc7d,17,"DROP TABLE",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 5.789 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.423 PDT,,,64646,"localhost:51390",62e46696.fc86,1,"",2022-07-29 16:00:38 PDT,,0,LOG,00000,"connection received: host=localhost port=51390",,,,,,,,,""
2022-07-29 16:00:38.428 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,2,"authentication",2022-07-29 16:00:38 PDT,3/2151,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:38.429 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,3,"idle",2022-07-29 16:00:38 PDT,3/2152,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.429 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,4,"BEGIN",2022-07-29 16:00:38 PDT,3/2152,0,LOG,00000,"duration: 0.086 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.429 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,5,"idle in transaction",2022-07-29 16:00:38 PDT,3/2152,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.429 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,6,"BEGIN",2022-07-29 16:00:38 PDT,3/2152,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:38.429 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,7,"BEGIN",2022-07-29 16:00:38 PDT,3/2152,0,LOG,00000,"duration: 0.026 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.431 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,8,"idle in transaction",2022-07-29 16:00:38 PDT,3/2152,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */


  create  table ""mimic"".""public"".""vitals_first_day__dbt_tmp""
  as (
    -- This query pivots the vital signs for the first 24 hours of a patient's stay
-- Vital signs include heart rate, blood pressure, respiration rate, and temperature

SELECT pvt.subject_id, pvt.hadm_id, pvt.icustay_id

-- Easier names
, min(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_min
, max(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_max
, avg(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_mean
, min(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_min
, max(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_max
, avg(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_mean
, min(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_min
, max(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_max
, avg(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_mean
, min(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_min
, max(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_max
, avg(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_mean
, min(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_min
, max(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_max
, avg(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_mean
, min(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_min
, max(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_max
, avg(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_mean
, min(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_min
, max(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_max
, avg(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_mean
, min(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_min
, max(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_max
, avg(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_mean

FROM  (
  select ie.subject_id, ie.hadm_id, ie.icustay_id
  , case
    when itemid in (211,220045) and valuenum > 0 and valuenum < 300 then 1 -- HeartRate
    when itemid in (51,442,455,6701,220179,220050) and valuenum > 0 and valuenum < 400 then 2 -- SysBP
    when itemid in (8368,8440,8441,8555,220180,220051) and valuenum > 0 and valuenum < 300 then 3 -- DiasBP
    when itemid in (456,52,6702,443,220052,220181,225312) and valuenum > 0 and valuenum < 300 then 4 -- MeanBP
    when itemid in (615,618,220210,224690) and valuenum > 0 and valuenum < 70 then 5 -- RespRate
    when itemid in (223761,678) and valuenum > 70 and valuenum < 120  then 6 -- TempF, converted to degC in valuenum call
    when itemid in (223762,676) and valuenum > 10 and valuenum < 50  then 6 -- TempC
    when itemid in (646,220277) and valuenum > 0 and valuenum <= 100 then 7 -- SpO2
    when itemid in (807,811,1529,3745,3744,225664,220621,226537) and valuenum > 0 then 8 -- Glucose

    else null end as vitalid
      -- convert F to C
  , case when itemid in (223761,678) then (valuenum-32)/1.8 else valuenum end as valuenum

  from icustays ie
  left join chartevents ce
  on ie.icustay_id = ce.icustay_id
  and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1 DAY')
  and DATETIME_DIFF(ce.charttime, ie.intime, 'SECOND') > 0
  and DATETIME_DIFF(ce.charttime, ie.intime, 'HOUR') <= 24
  -- exclude rows marked as error
  and (ce.error IS NULL or ce.error = 0)
  where ce.itemid in
  (
  -- HEART RATE
  211, --""Heart Rate""
  220045, --""Heart Rate""

  -- Systolic/diastolic

  51, --	Arterial BP [Systolic]
  442, --	Manual BP [Systolic]
  455, --	NBP [Systolic]
  6701, --	Arterial BP #2 [Systolic]
  220179, --	Non Invasive Blood Pressure systolic
  220050, --	Arterial Blood Pressure systolic

  8368, --	Arterial BP [Diastolic]
  8440, --	Manual BP [Diastolic]
  8441, --	NBP [Diastolic]
  8555, --	Arterial BP #2 [Diastolic]
  220180, --	Non Invasive Blood Pressure diastolic
  220051, --	Arterial Blood Pressure diastolic


  -- MEAN ARTERIAL PRESSURE
  456, --""NBP Mean""
  52, --""Arterial BP Mean""
  6702, --	Arterial BP Mean #2
  443, --	Manual BP Mean(calc)
  220052, --""Arterial Blood Pressure mean""
  220181, --""Non Invasive Blood Pressure mean""
  225312, --""ART BP mean""

  -- RESPIRATORY RATE
  618,--	Respiratory Rate
  615,--	Resp Rate (Total)
  220210,--	Respiratory Rate
  224690, --	Respiratory Rate (Total)


  -- SPO2, peripheral
  646, 220277,

  -- GLUCOSE, both lab and fingerstick
  807,--	Fingerstick Glucose
  811,--	Glucose (70-105)
  1529,--	Glucose
  3745,--	BloodGlucose
  3744,--	Blood Glucose
  225664,--	Glucose finger stick
  220621,--	Glucose (serum)
  226537,--	Glucose (whole blood)

  -- TEMPERATURE
  223762, -- ""Temperature Celsius""
  676,	-- ""Temperature C""
  223761, -- ""Temperature Fahrenheit""
  678 --	""Temperature F""

  )
) pvt
group by pvt.subject_id, pvt.hadm_id, pvt.icustay_id
order by pvt.subject_id, pvt.hadm_id, pvt.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:38.452 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,9,"CREATE TABLE AS",2022-07-29 16:00:38 PDT,3/2152,1903,LOG,00000,"duration: 21.124 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.458 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,10,"idle in transaction",2022-07-29 16:00:38 PDT,3/2152,1903,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
alter table ""mimic"".""public"".""vitals_first_day"" rename to ""vitals_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:38.459 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,11,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2152,1903,LOG,00000,"duration: 0.546 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.465 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,12,"idle in transaction",2022-07-29 16:00:38 PDT,3/2152,1903,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
alter table ""mimic"".""public"".""vitals_first_day__dbt_tmp"" rename to ""vitals_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:38.465 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,13,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2152,1903,LOG,00000,"duration: 0.465 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.471 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,14,"idle in transaction",2022-07-29 16:00:38 PDT,3/2152,1903,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:38.472 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,15,"COMMIT",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 0.871 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.475 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,16,"idle",2022-07-29 16:00:38 PDT,3/2153,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
drop table if exists ""mimic"".""public"".""vitals_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:38.477 PDT,"ceci","mimic",64646,"localhost:51390",62e46696.fc86,17,"DROP TABLE",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 1.658 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.514 PDT,,,64647,"localhost:51392",62e46696.fc87,1,"",2022-07-29 16:00:38 PDT,,0,LOG,00000,"connection received: host=localhost port=51392",,,,,,,,,""
2022-07-29 16:00:38.520 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,2,"authentication",2022-07-29 16:00:38 PDT,3/2154,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:38.521 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,3,"idle",2022-07-29 16:00:38 PDT,3/2155,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.521 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,4,"BEGIN",2022-07-29 16:00:38 PDT,3/2155,0,LOG,00000,"duration: 0.073 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.521 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,5,"idle in transaction",2022-07-29 16:00:38 PDT,3/2155,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.522 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,6,"BEGIN",2022-07-29 16:00:38 PDT,3/2155,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:38.522 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,7,"BEGIN",2022-07-29 16:00:38 PDT,3/2155,0,LOG,00000,"duration: 0.350 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.525 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,8,"idle in transaction",2022-07-29 16:00:38 PDT,3/2155,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */


  create  table ""mimic"".""public"".""weight_first_day__dbt_tmp""
  as (
    -- This query extracts weights for adult ICU patients on their first ICU day.
-- It does *not* use any information after the first ICU day, as weight is
-- sometimes used to monitor fluid balance.

-- ** Requires the echodata view, generated by concepts/echo-data.sql

with ce as
(
    SELECT
      c.icustay_id
      -- we take the avg value from roughly first day
      -- TODO: eliminate obvious outliers if there is a reasonable weight
      -- (e.g. weight of 180kg and 90kg would remove 180kg instead of taking the median)
      , AVG(VALUENUM) as Weight_Admit
    FROM chartevents c
    inner join icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (762,226512) -- Admit Wt
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
    group by c.icustay_id
)
, dwt as
(
    SELECT
      c.icustay_id
      , AVG(VALUENUM) as Weight_Daily
    FROM chartevents c
    INNER JOIN icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (763,224639) -- Daily Weight
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
    group by c.icustay_id
)
-- we split in-hospital/out of hospital echoes as we would like to prioritize in-hospital data
, echo_hadm as
(
    select
        ie.icustay_id
        , 0.453592*AVG(weight) as Weight_EchoInHosp
    from ""mimic"".""public"".""echo_data"" ec
    inner join icustays ie
        on ec.hadm_id = ie.hadm_id
        and ec.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    where
            ec.HADM_ID is not null
        and ec.weight is not null
    group by ie.icustay_id
)
, echo_nohadm as
(
    select
        ie.icustay_id
        , 0.453592*AVG(weight) as Weight_EchoPreHosp
    from ""mimic"".""public"".""echo_data"" ec
    inner join icustays ie
        on ie.subject_id = ec.subject_id
        and ie.intime < DATETIME_ADD(ec.charttime, INTERVAL '1' MONTH)
        and ie.intime > ec.charttime
    where
            ec.HADM_ID is null
        and ec.weight is not null
    group by ie.icustay_id
)
select
    ie.icustay_id
    , round(cast(
    case
        when ce.icustay_id is not null
            then ce.Weight_Admit
        when dwt.icustay_id is not null
            then dwt.Weight_Daily
        when eh.icustay_id is not null
            then eh.Weight_EchoInHosp
        when enh.icustay_id is not null
            then enh.Weight_EchoPreHosp
        else null end
        as numeric), 2)
    as weight

    -- components
    , ce.weight_admit
    , dwt.weight_daily
    , eh.weight_echoinhosp
    , enh.weight_echoprehosp

FROM icustays ie

-- filter to only adults
inner join patients pat
    on ie.subject_id = pat.subject_id
    and ie.intime > DATETIME_ADD(pat.dob, INTERVAL '1' YEAR)

-- admission weight
left join ce
    on ie.icustay_id = ce.icustay_id

-- daily weights
left join dwt
    on ie.icustay_id = dwt.icustay_id

-- in-hospital echo weight
left join echo_hadm eh
    on ie.icustay_id = eh.icustay_id

-- pre-hospitalization echo weights
left join echo_nohadm enh
    on ie.icustay_id = enh.icustay_id
order by ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:00:38.704 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,9,"CREATE TABLE AS",2022-07-29 16:00:38 PDT,3/2155,1905,LOG,00000,"duration: 179.455 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.711 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,10,"idle in transaction",2022-07-29 16:00:38 PDT,3/2155,1905,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
alter table ""mimic"".""public"".""weight_first_day"" rename to ""weight_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:38.711 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,11,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2155,1905,LOG,00000,"duration: 0.370 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.718 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,12,"idle in transaction",2022-07-29 16:00:38 PDT,3/2155,1905,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
alter table ""mimic"".""public"".""weight_first_day__dbt_tmp"" rename to ""weight_first_day""",,,,,,,,,"dbt"
2022-07-29 16:00:38.718 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,13,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2155,1905,LOG,00000,"duration: 0.326 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.723 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,14,"idle in transaction",2022-07-29 16:00:38 PDT,3/2155,1905,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:38.729 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,15,"COMMIT",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 5.650 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.733 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,16,"idle",2022-07-29 16:00:38 PDT,3/2156,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
drop table if exists ""mimic"".""public"".""weight_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:38.734 PDT,"ceci","mimic",64647,"localhost:51392",62e46696.fc87,17,"DROP TABLE",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 1.820 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.759 PDT,,,64648,"localhost:51394",62e46696.fc88,1,"",2022-07-29 16:00:38 PDT,,0,LOG,00000,"connection received: host=localhost port=51394",,,,,,,,,""
2022-07-29 16:00:38.764 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,2,"authentication",2022-07-29 16:00:38 PDT,3/2157,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:38.765 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,3,"idle",2022-07-29 16:00:38 PDT,3/2158,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.765 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,4,"BEGIN",2022-07-29 16:00:38 PDT,3/2158,0,LOG,00000,"duration: 0.105 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.765 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,5,"idle in transaction",2022-07-29 16:00:38 PDT,3/2158,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.765 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,6,"BEGIN",2022-07-29 16:00:38 PDT,3/2158,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:38.765 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,7,"BEGIN",2022-07-29 16:00:38 PDT,3/2158,0,LOG,00000,"duration: 0.055 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.767 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,8,"idle in transaction",2022-07-29 16:00:38 PDT,3/2158,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */


  create  table ""mimic"".""public"".""blood_gas_first_day_arterial__dbt_tmp""
  as (
    with stg_spo2 as
(
  select subject_id, hadm_id, icustay_id, charttime
    -- max here is just used to group SpO2 by charttime
    , max(case when valuenum <= 0 or valuenum > 100 then null else valuenum end) as SpO2
  FROM chartevents
  -- o2 sat
  where ITEMID in
  (
    646 -- SpO2
  , 220277 -- O2 saturation pulseoxymetry
  )
  group by subject_id, hadm_id, icustay_id, charttime
)
, stg_fio2 as
(
  select subject_id, hadm_id, icustay_id, charttime
    -- pre-process the FiO2s to ensure they are between 21-100%
    , max(
        case
          when itemid = 223835
            then case
              when valuenum > 0 and valuenum <= 1
                then valuenum * 100
              -- improperly input data - looks like O2 flow in litres
              when valuenum > 1 and valuenum < 21
                then null
              when valuenum >= 21 and valuenum <= 100
                then valuenum
              else null end -- unphysiological
        when itemid in (3420, 3422)
        -- all these values are well formatted
            then valuenum
        when itemid = 190 and valuenum > 0.20 and valuenum < 1
        -- well formatted but not in %
            then valuenum * 100
      else null end
    ) as fio2_chartevents
  FROM chartevents
  where ITEMID in
  (
    3420 -- FiO2
  , 190 -- FiO2 set
  , 223835 -- Inspired O2 Fraction (FiO2)
  , 3422 -- FiO2 [measured]
  )
  -- exclude rows marked as error
  AND (error IS NULL OR error = 0)
  group by subject_id, hadm_id, icustay_id, charttime
)
, stg2 as
(
select bg.*
  , ROW_NUMBER() OVER (partition by bg.icustay_id, bg.charttime order by s1.charttime DESC) as lastRowSpO2
  , s1.spo2
from ""mimic"".""public"".""blood_gas_first_day"" bg
left join stg_spo2 s1
  -- same patient
  on  bg.icustay_id = s1.icustay_id
  -- spo2 occurred at most 2 hours before this blood gas
  and s1.charttime >= DATETIME_SUB(bg.charttime, INTERVAL '2' HOUR)
  and s1.charttime <= bg.charttime
where bg.po2 is not null
)
, stg3 as
(
select bg.*
  , ROW_NUMBER() OVER (partition by bg.icustay_id, bg.charttime order by s2.charttime DESC) as lastRowFiO2
  , s2.fio2_chartevents

  -- create our specimen prediction
  ,  1/(1+exp(-(-0.02544
  +    0.04598 * po2
  + coalesce(-0.15356 * spo2             , -0.15356 *   97.49420 +    0.13429)
  + coalesce( 0.00621 * fio2_chartevents ,  0.00621 *   51.49550 +   -0.24958)
  + coalesce( 0.10559 * hemoglobin       ,  0.10559 *   10.32307 +    0.05954)
  + coalesce( 0.13251 * so2              ,  0.13251 *   93.66539 +   -0.23172)
  + coalesce(-0.01511 * pco2             , -0.01511 *   42.08866 +   -0.01630)
  + coalesce( 0.01480 * fio2             ,  0.01480 *   63.97836 +   -0.31142)
  + coalesce(-0.00200 * aado2            , -0.00200 *  442.21186 +   -0.01328)
  + coalesce(-0.03220 * bicarbonate      , -0.03220 *   22.96894 +   -0.06535)
  + coalesce( 0.05384 * totalco2         ,  0.05384 *   24.72632 +   -0.01405)
  + coalesce( 0.08202 * lactate          ,  0.08202 *    3.06436 +    0.06038)
  + coalesce( 0.10956 * ph               ,  0.10956 *    7.36233 +   -0.00617)
  + coalesce( 0.00848 * o2flow           ,  0.00848 *    7.59362 +   -0.35803)
  ))) as SPECIMEN_PROB
from stg2 bg
left join stg_fio2 s2
  -- same patient
  on  bg.icustay_id = s2.icustay_id
  -- fio2 occurred at most 4 hours before this blood gas
  and s2.charttime between DATETIME_SUB(bg.charttime, INTERVAL '4' HOUR) and bg.charttime
where bg.lastRowSpO2 = 1 -- only the row with the most recent SpO2 (if no SpO2 found lastRowSpO2 = 1)
)

select subject_id, hadm_id,
icustay_id, charttime
, specimen -- raw data indicating sample type, only present 80% of the time

-- prediction of specimen for missing data
, case
      when SPECIMEN is not null then SPECIMEN
      when SPECIMEN_PROB > 0.75 then 'ART'
    else null end as SPECIMEN_PRED
, specimen_prob
-- oxygen related parameters
, so2, spo2 -- note spo2 is FROM chartevents
, po2, pco2
, fio2_chartevents, fio2
, aado2
-- also calculate AADO2
, case
    when  PO2 is not null
      and pco2 is not null
      and coalesce(fio2, fio2_chartevents) is not null
     -- multiple by 100 because FiO2 is in a % but should be a fraction
      then (coalesce(fio2, fio2_chartevents)/100) * (760 - 47) - (pco2/0.8) - po2
    else null
  end as AADO2_calc
, case
    when PO2 is not null and coalesce(fio2, fio2_chartevents) is not null
     -- multiply by 100 because FiO2 is in a % but should be a fraction
      then 100*PO2/(coalesce(fio2, fio2_chartevents))
    else null
  end as PaO2FiO2
-- acid-base parameters
, ph, baseexcess
, bicarbonate, totalco2

-- blood count parameters
, hematocrit
, hemoglobin
, carboxyhemoglobin
, methemoglobin

-- chemistry
, chloride, calcium
, temperature
, potassium, sodium
, lactate
, glucose

-- ventilation stuff that's sometimes input
, intubated, tidalvolume, ventilationrate, ventilator
, peep, o2flow
, requiredo2

from stg3
where lastRowFiO2 = 1 -- only the most recent FiO2
-- restrict it to *only* arterial samples
and (specimen = 'ART' or specimen_prob > 0.75)
order by icustay_id, charttime
  );",,,,,,,,,"dbt"
2022-07-29 16:00:38.795 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,9,"CREATE TABLE AS",2022-07-29 16:00:38 PDT,3/2158,1907,LOG,00000,"duration: 28.149 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.805 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,10,"idle in transaction",2022-07-29 16:00:38 PDT,3/2158,1907,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
alter table ""mimic"".""public"".""blood_gas_first_day_arterial"" rename to ""blood_gas_first_day_arterial__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:00:38.805 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,11,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2158,1907,LOG,00000,"duration: 0.429 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.815 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,12,"idle in transaction",2022-07-29 16:00:38 PDT,3/2158,1907,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
alter table ""mimic"".""public"".""blood_gas_first_day_arterial__dbt_tmp"" rename to ""blood_gas_first_day_arterial""",,,,,,,,,"dbt"
2022-07-29 16:00:38.816 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,13,"ALTER TABLE",2022-07-29 16:00:38 PDT,3/2158,1907,LOG,00000,"duration: 0.314 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.824 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,14,"idle in transaction",2022-07-29 16:00:38 PDT,3/2158,1907,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:38.825 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,15,"COMMIT",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 0.868 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.830 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,16,"idle",2022-07-29 16:00:38 PDT,3/2159,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
drop table if exists ""mimic"".""public"".""blood_gas_first_day_arterial__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:00:38.832 PDT,"ceci","mimic",64648,"localhost:51394",62e46696.fc88,17,"DROP TABLE",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 1.732 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.850 PDT,,,64649,"localhost:51396",62e46696.fc89,1,"",2022-07-29 16:00:38 PDT,,0,LOG,00000,"connection received: host=localhost port=51396",,,,,,,,,""
2022-07-29 16:00:38.855 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,2,"authentication",2022-07-29 16:00:38 PDT,3/2160,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:00:38.858 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,3,"idle",2022-07-29 16:00:38 PDT,3/2161,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.858 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,4,"BEGIN",2022-07-29 16:00:38 PDT,3/2161,0,LOG,00000,"duration: 0.222 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.858 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,5,"idle in transaction",2022-07-29 16:00:38 PDT,3/2161,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:00:38.858 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,6,"BEGIN",2022-07-29 16:00:38 PDT,3/2161,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:00:38.858 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,7,"BEGIN",2022-07-29 16:00:38 PDT,3/2161,0,LOG,00000,"duration: 0.175 ms",,,,,,,,,"dbt"
2022-07-29 16:00:38.860 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,8,"idle in transaction",2022-07-29 16:00:38 PDT,3/2161,0,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:00:38.860 PDT,"ceci","mimic",64649,"localhost:51396",62e46696.fc89,9,"COMMIT",2022-07-29 16:00:38 PDT,3/0,0,LOG,00000,"duration: 0.069 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.371 PDT,,,64753,"localhost:51484",62e466bf.fcf1,1,"",2022-07-29 16:01:19 PDT,,0,LOG,00000,"connection received: host=localhost port=51484",,,,,,,,,""
2022-07-29 16:01:19.379 PDT,"ceci","mimic",64753,"localhost:51484",62e466bf.fcf1,2,"authentication",2022-07-29 16:01:19 PDT,3/2186,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:19.380 PDT,"ceci","mimic",64753,"localhost:51484",62e466bf.fcf1,3,"idle",2022-07-29 16:01:19 PDT,3/2187,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.380 PDT,"ceci","mimic",64753,"localhost:51484",62e466bf.fcf1,4,"BEGIN",2022-07-29 16:01:19 PDT,3/2187,0,LOG,00000,"duration: 0.095 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.381 PDT,"ceci","mimic",64753,"localhost:51484",62e466bf.fcf1,5,"idle in transaction",2022-07-29 16:01:19 PDT,3/2187,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_mimic""} */

    select distinct nspname from pg_namespace
  ",,,,,,,,,"dbt"
2022-07-29 16:01:19.382 PDT,"ceci","mimic",64753,"localhost:51484",62e466bf.fcf1,6,"SELECT",2022-07-29 16:01:19 PDT,3/2187,0,LOG,00000,"duration: 0.972 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.423 PDT,,,64755,"localhost:51488",62e466bf.fcf3,1,"",2022-07-29 16:01:19 PDT,,0,LOG,00000,"connection received: host=localhost port=51488",,,,,,,,,""
2022-07-29 16:01:19.429 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,2,"authentication",2022-07-29 16:01:19 PDT,3/2188,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:19.431 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,3,"idle",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.431 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,4,"BEGIN",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"duration: 0.134 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.431 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,5,"idle in transaction",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.431 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,6,"BEGIN",2022-07-29 16:01:19 PDT,3/2189,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:19.431 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,7,"BEGIN",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"duration: 0.063 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.435 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,8,"idle in transaction",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""list_mimic_public""} */
select
      'mimic' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'public'
    union all
    select
      'mimic' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'public'
  ",,,,,,,,,"dbt"
2022-07-29 16:01:19.440 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,9,"SELECT",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"duration: 5.118 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.452 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,10,"idle in transaction",2022-07-29 16:01:19 PDT,3/2189,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 16:01:19.452 PDT,"ceci","mimic",64755,"localhost:51488",62e466bf.fcf3,11,"ROLLBACK",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 0.095 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.475 PDT,,,64759,"localhost:51490",62e466bf.fcf7,1,"",2022-07-29 16:01:19 PDT,,0,LOG,00000,"connection received: host=localhost port=51490",,,,,,,,,""
2022-07-29 16:01:19.480 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,2,"authentication",2022-07-29 16:01:19 PDT,3/2190,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:19.480 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,3,"idle",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.480 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,4,"BEGIN",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"duration: 0.085 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.481 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,5,"idle in transaction",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.481 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,6,"BEGIN",2022-07-29 16:01:19 PDT,3/2191,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:19.481 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,7,"BEGIN",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"duration: 0.089 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.483 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,8,"idle in transaction",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""connection_name"": ""master""} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;",,,,,,,,,"dbt"
2022-07-29 16:01:19.486 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,9,"SELECT",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"duration: 3.358 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.491 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,10,"idle in transaction",2022-07-29 16:01:19 PDT,3/2191,0,LOG,00000,"statement: ROLLBACK",,,,,,,,,"dbt"
2022-07-29 16:01:19.491 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,11,"ROLLBACK",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 0.093 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.492 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,12,"idle",2022-07-29 16:01:19 PDT,3/2192,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.492 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,13,"BEGIN",2022-07-29 16:01:19 PDT,3/2192,0,LOG,00000,"duration: 0.059 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.492 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,14,"idle in transaction",2022-07-29 16:01:19 PDT,3/2192,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.492 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,15,"BEGIN",2022-07-29 16:01:19 PDT,3/2192,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:19.492 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,16,"BEGIN",2022-07-29 16:01:19 PDT,3/2192,0,LOG,00000,"duration: 0.052 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.494 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,17,"idle in transaction",2022-07-29 16:01:19 PDT,3/2192,0,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:19.494 PDT,"ceci","mimic",64759,"localhost:51490",62e466bf.fcf7,18,"COMMIT",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 0.062 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.551 PDT,,,64764,"localhost:51492",62e466bf.fcfc,1,"",2022-07-29 16:01:19 PDT,,0,LOG,00000,"connection received: host=localhost port=51492",,,,,,,,,""
2022-07-29 16:01:19.555 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,2,"authentication",2022-07-29 16:01:19 PDT,3/2193,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:19.556 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,3,"idle",2022-07-29 16:01:19 PDT,3/2194,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.556 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,4,"BEGIN",2022-07-29 16:01:19 PDT,3/2194,0,LOG,00000,"duration: 0.123 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.557 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,5,"idle in transaction",2022-07-29 16:01:19 PDT,3/2194,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.557 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,6,"BEGIN",2022-07-29 16:01:19 PDT,3/2194,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:19.557 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,7,"BEGIN",2022-07-29 16:01:19 PDT,3/2194,0,LOG,00000,"duration: 0.054 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.559 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,8,"idle in transaction",2022-07-29 16:01:19 PDT,3/2194,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */


  create  table ""mimic"".""public"".""blood_gas_first_day__dbt_tmp""
  as (
    -- The aim of this query is to pivot entries related to blood gases and
-- chemistry values which were found in LABEVENTS

-- things to check:
--  when a mixed venous/arterial blood sample are taken at the same time, is the store time different?

with pvt as
( -- begin query that extracts the data
  select ie.subject_id, ie.hadm_id, ie.icustay_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
      , case
        when itemid = 50800 then 'SPECIMEN'
        when itemid = 50801 then 'AADO2'
        when itemid = 50802 then 'BASEEXCESS'
        when itemid = 50803 then 'BICARBONATE'
        when itemid = 50804 then 'TOTALCO2'
        when itemid = 50805 then 'CARBOXYHEMOGLOBIN'
        when itemid = 50806 then 'CHLORIDE'
        when itemid = 50808 then 'CALCIUM'
        when itemid = 50809 then 'GLUCOSE'
        when itemid = 50810 then 'HEMATOCRIT'
        when itemid = 50811 then 'HEMOGLOBIN'
        when itemid = 50812 then 'INTUBATED'
        when itemid = 50813 then 'LACTATE'
        when itemid = 50814 then 'METHEMOGLOBIN'
        when itemid = 50815 then 'O2FLOW'
        when itemid = 50816 then 'FIO2'
        when itemid = 50817 then 'SO2' -- OXYGENSATURATION
        when itemid = 50818 then 'PCO2'
        when itemid = 50819 then 'PEEP'
        when itemid = 50820 then 'PH'
        when itemid = 50821 then 'PO2'
        when itemid = 50822 then 'POTASSIUM'
        when itemid = 50823 then 'REQUIREDO2'
        when itemid = 50824 then 'SODIUM'
        when itemid = 50825 then 'TEMPERATURE'
        when itemid = 50826 then 'TIDALVOLUME'
        when itemid = 50827 then 'VENTILATIONRATE'
        when itemid = 50828 then 'VENTILATOR'
        else null
        end as label
        , charttime
        , value
        -- add in some sanity checks on the values
        , case
          when valuenum <= 0 and itemid != 50802 then null -- allow negative baseexcess
          when itemid = 50810 and valuenum > 100 then null -- hematocrit
          -- ensure FiO2 is a valid number between 21-100
          -- mistakes are rare (<100 obs out of ~100,000)
          -- there are 862 obs of valuenum == 20 - some people round down!
          -- rather than risk imputing garbage data for FiO2, we simply NULL invalid values
          when itemid = 50816 and valuenum < 20 then null
          when itemid = 50816 and valuenum > 100 then null
          when itemid = 50817 and valuenum > 100 then null -- O2 sat
          when itemid = 50815 and valuenum >  70 then null -- O2 flow
          when itemid = 50821 and valuenum > 800 then null -- PO2
           -- conservative upper limit
        else valuenum
        end as valuenum

    FROM icustays ie
    left join labevents le
      on le.subject_id = ie.subject_id and le.hadm_id = ie.hadm_id
      and le.charttime between (DATETIME_SUB(ie.intime, INTERVAL '6' HOUR)) and (DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
      and le.ITEMID in
      -- blood gases
      (
        50800, 50801, 50802, 50803, 50804, 50805, 50806, 50807, 50808, 50809
        , 50810, 50811, 50812, 50813, 50814, 50815, 50816, 50817, 50818, 50819
        , 50820, 50821, 50822, 50823, 50824, 50825, 50826, 50827, 50828
        , 51545
      )
)
select pvt.SUBJECT_ID, pvt.HADM_ID, pvt.ICUSTAY_ID, pvt.CHARTTIME
, max(case when label = 'SPECIMEN' then value else null end) as specimen
, max(case when label = 'AADO2' then valuenum else null end) as aado2
, max(case when label = 'BASEEXCESS' then valuenum else null end) as baseexcess
, max(case when label = 'BICARBONATE' then valuenum else null end) as bicarbonate
, max(case when label = 'TOTALCO2' then valuenum else null end) as totalco2
, max(case when label = 'CARBOXYHEMOGLOBIN' then valuenum else null end) as carboxyhemoglobin
, max(case when label = 'CHLORIDE' then valuenum else null end) as chloride
, max(case when label = 'CALCIUM' then valuenum else null end) as calcium
, max(case when label = 'GLUCOSE' then valuenum else null end) as glucose
, max(case when label = 'HEMATOCRIT' then valuenum else null end) as hematocrit
, max(case when label = 'HEMOGLOBIN' then valuenum else null end) as hemoglobin
, max(case when label = 'INTUBATED' then valuenum else null end) as intubated
, max(case when label = 'LACTATE' then valuenum else null end) as lactate
, max(case when label = 'METHEMOGLOBIN' then valuenum else null end) as methemoglobin
, max(case when label = 'O2FLOW' then valuenum else null end) as o2flow
, max(case when label = 'FIO2' then valuenum else null end) as fio2
, max(case when label = 'SO2' then valuenum else null end) as so2 -- OXYGENSATURATION
, max(case when label = 'PCO2' then valuenum else null end) as pco2
, max(case when label = 'PEEP' then valuenum else null end) as peep
, max(case when label = 'PH' then valuenum else null end) as ph
, max(case when label = 'PO2' then valuenum else null end) as po2
, max(case when label = 'POTASSIUM' then valuenum else null end) as potassium
, max(case when label = 'REQUIREDO2' then valuenum else null end) as requiredo2
, max(case when label = 'SODIUM' then valuenum else null end) as sodium
, max(case when label = 'TEMPERATURE' then valuenum else null end) as temperature
, max(case when label = 'TIDALVOLUME' then valuenum else null end) as tidalvolume
, max(case when label = 'VENTILATIONRATE' then valuenum else null end) as ventilationrate
, max(case when label = 'VENTILATOR' then valuenum else null end) as ventilator
from pvt
group by pvt.subject_id, pvt.hadm_id, pvt.icustay_id, pvt.CHARTTIME
order by pvt.subject_id, pvt.hadm_id, pvt.icustay_id, pvt.CHARTTIME
  );",,,,,,,,,"dbt"
2022-07-29 16:01:19.724 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,9,"CREATE TABLE AS",2022-07-29 16:01:19 PDT,3/2194,1918,LOG,00000,"duration: 165.782 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.737 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,10,"idle in transaction",2022-07-29 16:01:19 PDT,3/2194,1918,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
alter table ""mimic"".""public"".""blood_gas_first_day"" rename to ""blood_gas_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:19.737 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,11,"ALTER TABLE",2022-07-29 16:01:19 PDT,3/2194,1918,LOG,00000,"duration: 0.279 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.742 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,12,"idle in transaction",2022-07-29 16:01:19 PDT,3/2194,1918,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
alter table ""mimic"".""public"".""blood_gas_first_day__dbt_tmp"" rename to ""blood_gas_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:19.742 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,13,"ALTER TABLE",2022-07-29 16:01:19 PDT,3/2194,1918,LOG,00000,"duration: 0.270 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.753 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,14,"idle in transaction",2022-07-29 16:01:19 PDT,3/2194,1918,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:19.760 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,15,"COMMIT",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 6.362 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.768 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,16,"idle",2022-07-29 16:01:19 PDT,3/2195,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day""} */
drop table if exists ""mimic"".""public"".""blood_gas_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:19.770 PDT,"ceci","mimic",64764,"localhost:51492",62e466bf.fcfc,17,"DROP TABLE",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 1.964 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.796 PDT,,,64765,"localhost:51494",62e466bf.fcfd,1,"",2022-07-29 16:01:19 PDT,,0,LOG,00000,"connection received: host=localhost port=51494",,,,,,,,,""
2022-07-29 16:01:19.802 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,2,"authentication",2022-07-29 16:01:19 PDT,3/2196,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:19.803 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,3,"idle",2022-07-29 16:01:19 PDT,3/2197,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.803 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,4,"BEGIN",2022-07-29 16:01:19 PDT,3/2197,0,LOG,00000,"duration: 0.228 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.803 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,5,"idle in transaction",2022-07-29 16:01:19 PDT,3/2197,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.803 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,6,"BEGIN",2022-07-29 16:01:19 PDT,3/2197,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:19.803 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,7,"BEGIN",2022-07-29 16:01:19 PDT,3/2197,0,LOG,00000,"duration: 0.173 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.806 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,8,"idle in transaction",2022-07-29 16:01:19 PDT,3/2197,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */


  create  table ""mimic"".""public"".""gcs_first_day__dbt_tmp""
  as (
    -- ITEMIDs used:

-- CAREVUE
--    723 as GCSVerbal
--    454 as GCSMotor
--    184 as GCSEyes

-- METAVISION
--    223900 GCS - Verbal Response
--    223901 GCS - Motor Response
--    220739 GCS - Eye Opening

-- The code combines the ITEMIDs into the carevue itemids, then pivots those
-- So 223900 is changed to 723, then the ITEMID 723 is pivoted to form GCSVerbal

-- Note:
--  The GCS for sedated patients is defaulted to 15 in this code.
--  This is in line with how the data is meant to be collected.
--  e.g., from the SAPS II publication:
--    For sedated patients, the Glasgow Coma Score before sedation was used.
--    This was ascertained either from interviewing the physician who ordered the sedation,
--    or by reviewing the patient's medical record.

with base as
(
  SELECT pvt.ICUSTAY_ID
  , pvt.charttime

  -- Easier names - note we coalesced Metavision and CareVue IDs below
  , max(case when pvt.itemid = 454 then pvt.valuenum else null end) as GCSMotor
  , max(case when pvt.itemid = 723 then pvt.valuenum else null end) as GCSVerbal
  , max(case when pvt.itemid = 184 then pvt.valuenum else null end) as GCSEyes

  -- If verbal was set to 0 in the below select, then this is an intubated patient
  , case
      when max(case when pvt.itemid = 723 then pvt.valuenum else null end) = 0
    then 1
    else 0
    end as EndoTrachFlag

  , ROW_NUMBER ()
          OVER (PARTITION BY pvt.ICUSTAY_ID ORDER BY pvt.charttime ASC) as rn

  FROM  (
  select l.ICUSTAY_ID
  -- merge the ITEMIDs so that the pivot applies to both metavision/carevue data
  , case
      when l.ITEMID in (723,223900) then 723
      when l.ITEMID in (454,223901) then 454
      when l.ITEMID in (184,220739) then 184
      else l.ITEMID end
    as ITEMID

  -- convert the data into a number, reserving a value of 0 for ET/Trach
  , case
      -- endotrach/vent is assigned a value of 0, later parsed specially
      when l.ITEMID = 723 and l.VALUE = '1.0 ET/Trach' then 0 -- carevue
      when l.ITEMID = 223900 and l.VALUE = 'No Response-ETT' then 0 -- metavision

      else VALUENUM
      end
    as VALUENUM
  , l.CHARTTIME
  FROM chartevents l

  -- get intime for charttime subselection
  inner join icustays b
    on l.icustay_id = b.icustay_id

  -- Isolate the desired GCS variables
  where l.ITEMID in
  (
    -- 198 -- GCS
    -- GCS components, CareVue
    184, 454, 723
    -- GCS components, Metavision
    , 223900, 223901, 220739
  )
  -- Only get data for the first 24 hours
  and l.charttime between b.intime and DATETIME_ADD(b.intime, INTERVAL '1' DAY)
  -- exclude rows marked as error
  AND (l.error IS NULL OR l.error = 0)
  ) pvt
  group by pvt.ICUSTAY_ID, pvt.charttime
)
, gcs as (
  select b.*
  , b2.GCSVerbal as GCSVerbalPrev
  , b2.GCSMotor as GCSMotorPrev
  , b2.GCSEyes as GCSEyesPrev
  -- Calculate GCS, factoring in special case when they are intubated and prev vals
  -- note that the coalesce are used to implement the following if:
  --  if current value exists, use it
  --  if previous value exists, use it
  --  otherwise, default to normal
  , case
      -- replace GCS during sedation with 15
      when b.GCSVerbal = 0
        then 15
      when b.GCSVerbal is null and b2.GCSVerbal = 0
        then 15
      -- if previously they were intub, but they aren't now, do not use previous GCS values
      when b2.GCSVerbal = 0
        then
            coalesce(b.GCSMotor,6)
          + coalesce(b.GCSVerbal,5)
          + coalesce(b.GCSEyes,4)
      -- otherwise, add up score normally, imputing previous value if none available at current time
      else
            coalesce(b.GCSMotor,coalesce(b2.GCSMotor,6))
          + coalesce(b.GCSVerbal,coalesce(b2.GCSVerbal,5))
          + coalesce(b.GCSEyes,coalesce(b2.GCSEyes,4))
      end as GCS

  from base b
  -- join to itself within 6 hours to get previous value
  left join base b2
    on b.ICUSTAY_ID = b2.ICUSTAY_ID and b.rn = b2.rn+1 and b2.charttime > DATETIME_SUB(b.charttime, INTERVAL '6' HOUR)
)
, gcs_final as (
  select gcs.*
  -- This sorts the data by GCS, so rn=1 is the the lowest GCS values to keep
  , ROW_NUMBER ()
          OVER (PARTITION BY gcs.ICUSTAY_ID
                ORDER BY gcs.GCS
               ) as IsMinGCS
  from gcs
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
-- The minimum GCS is determined by the above row partition, we only join if IsMinGCS=1
, GCS as mingcs
, coalesce(GCSMotor,GCSMotorPrev) as gcsmotor
, coalesce(GCSVerbal,GCSVerbalPrev) as gcsverbal
, coalesce(GCSEyes,GCSEyesPrev) as gcseyes
, EndoTrachFlag as endotrachflag

-- subselect down to the cohort of eligible patients
FROM icustays ie
left join gcs_final gs
  on ie.icustay_id = gs.icustay_id and gs.IsMinGCS = 1
ORDER BY ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:19.903 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,9,"CREATE TABLE AS",2022-07-29 16:01:19 PDT,3/2197,1920,LOG,00000,"duration: 98.243 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.908 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,10,"idle in transaction",2022-07-29 16:01:19 PDT,3/2197,1920,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
alter table ""mimic"".""public"".""gcs_first_day"" rename to ""gcs_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:19.908 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,11,"ALTER TABLE",2022-07-29 16:01:19 PDT,3/2197,1920,LOG,00000,"duration: 0.213 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.914 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,12,"idle in transaction",2022-07-29 16:01:19 PDT,3/2197,1920,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
alter table ""mimic"".""public"".""gcs_first_day__dbt_tmp"" rename to ""gcs_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:19.914 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,13,"ALTER TABLE",2022-07-29 16:01:19 PDT,3/2197,1920,LOG,00000,"duration: 0.253 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.918 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,14,"idle in transaction",2022-07-29 16:01:19 PDT,3/2197,1920,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:19.924 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,15,"COMMIT",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 5.703 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.927 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,16,"idle",2022-07-29 16:01:19 PDT,3/2198,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.gcs_first_day""} */
drop table if exists ""mimic"".""public"".""gcs_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:19.928 PDT,"ceci","mimic",64765,"localhost:51494",62e466bf.fcfd,17,"DROP TABLE",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 1.289 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.953 PDT,,,64766,"localhost:51496",62e466bf.fcfe,1,"",2022-07-29 16:01:19 PDT,,0,LOG,00000,"connection received: host=localhost port=51496",,,,,,,,,""
2022-07-29 16:01:19.959 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,2,"authentication",2022-07-29 16:01:19 PDT,3/2199,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:19.961 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,3,"idle",2022-07-29 16:01:19 PDT,3/2200,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.961 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,4,"BEGIN",2022-07-29 16:01:19 PDT,3/2200,0,LOG,00000,"duration: 0.087 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.961 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,5,"idle in transaction",2022-07-29 16:01:19 PDT,3/2200,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:19.961 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,6,"BEGIN",2022-07-29 16:01:19 PDT,3/2200,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:19.961 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,7,"BEGIN",2022-07-29 16:01:19 PDT,3/2200,0,LOG,00000,"duration: 0.030 ms",,,,,,,,,"dbt"
2022-07-29 16:01:19.964 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,8,"idle in transaction",2022-07-29 16:01:19 PDT,3/2200,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */


  create  table ""mimic"".""public"".""height_first_day__dbt_tmp""
  as (
    -- This query extracts heights for adult ICU patients.
-- It uses all information from the patient's first ICU day.
-- This is done for consistency with other queries - it's not necessarily needed.
-- Height is unlikely to change throughout a patient's stay.

-- ** Requires the echodata view, generated by concepts/echo-data.sql

-- staging table to ensure all heights are in centimeters
with ce0 as
(
    SELECT
      c.icustay_id
      , case
        -- convert inches to centimetres
          when itemid in (920, 1394, 4187, 3486)
              then valuenum * 2.54
            else valuenum
        end as Height
    FROM chartevents c
    inner join icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (226730,920, 1394, 4187, 3486,3485,4188) -- height
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
)
, ce as
(
    SELECT
        icustay_id
        -- extract the median height from the chart to add robustness against outliers
        , AVG(height) as Height_chart
    from ce0
    where height > 100
    group by icustay_id
)
-- requires the echo-data.sql query to run
-- this adds heights from the free-text echo notes
, echo as
(
    select
        ec.subject_id
        -- all echo heights are in inches
        , 2.54*AVG(height) as Height_Echo
    from ""mimic"".""public"".""echo_data"" ec
    inner join icustays ie
        on ec.subject_id = ie.subject_id
        and ec.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    where height is not null
    and height*2.54 > 100
    group by ec.subject_id
)
select
    ie.icustay_id
    , coalesce(ce.Height_chart, ec.Height_Echo) as height

    -- components
    , ce.height_chart
    , ec.height_echo
FROM icustays ie

-- filter to only adults
inner join patients pat
    on ie.subject_id = pat.subject_id
    and ie.intime > DATETIME_ADD(pat.dob, INTERVAL '1' YEAR)

left join ce
    on ie.icustay_id = ce.icustay_id

left join echo ec
    on ie.subject_id = ec.subject_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:20.104 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,9,"CREATE TABLE AS",2022-07-29 16:01:19 PDT,3/2200,1922,LOG,00000,"duration: 140.290 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.112 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,10,"idle in transaction",2022-07-29 16:01:19 PDT,3/2200,1922,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
alter table ""mimic"".""public"".""height_first_day"" rename to ""height_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:20.113 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,11,"ALTER TABLE",2022-07-29 16:01:19 PDT,3/2200,1922,LOG,00000,"duration: 0.247 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.121 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,12,"idle in transaction",2022-07-29 16:01:19 PDT,3/2200,1922,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
alter table ""mimic"".""public"".""height_first_day__dbt_tmp"" rename to ""height_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:20.121 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,13,"ALTER TABLE",2022-07-29 16:01:19 PDT,3/2200,1922,LOG,00000,"duration: 0.361 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.125 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,14,"idle in transaction",2022-07-29 16:01:19 PDT,3/2200,1922,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:20.130 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,15,"COMMIT",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 4.597 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.133 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,16,"idle",2022-07-29 16:01:19 PDT,3/2201,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.height_first_day""} */
drop table if exists ""mimic"".""public"".""height_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:20.134 PDT,"ceci","mimic",64766,"localhost:51496",62e466bf.fcfe,17,"DROP TABLE",2022-07-29 16:01:19 PDT,3/0,0,LOG,00000,"duration: 1.453 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.160 PDT,,,64767,"localhost:51498",62e466c0.fcff,1,"",2022-07-29 16:01:20 PDT,,0,LOG,00000,"connection received: host=localhost port=51498",,,,,,,,,""
2022-07-29 16:01:20.165 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,2,"authentication",2022-07-29 16:01:20 PDT,3/2202,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:20.166 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,3,"idle",2022-07-29 16:01:20 PDT,3/2203,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:20.167 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,4,"BEGIN",2022-07-29 16:01:20 PDT,3/2203,0,LOG,00000,"duration: 0.114 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.167 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,5,"idle in transaction",2022-07-29 16:01:20 PDT,3/2203,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:20.167 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,6,"BEGIN",2022-07-29 16:01:20 PDT,3/2203,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:20.167 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,7,"BEGIN",2022-07-29 16:01:20 PDT,3/2203,0,LOG,00000,"duration: 0.101 ms",,,,,,,,,"dbt"
2022-07-29 16:01:20.170 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,8,"idle in transaction",2022-07-29 16:01:20 PDT,3/2203,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */


  create  table ""mimic"".""public"".""labs_first_day__dbt_tmp""
  as (
    -- This query pivots lab values taken in the first 24 hours of a patient's stay

-- Have already confirmed that the unit of measurement is always the same: null or the correct unit

SELECT
  pvt.subject_id, pvt.hadm_id, pvt.icustay_id

  , min(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE NULL END) AS aniongap_min
  , max(CASE WHEN label = 'ANION GAP' THEN valuenum ELSE NULL END) AS aniongap_max
  , min(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE NULL END) AS albumin_min
  , max(CASE WHEN label = 'ALBUMIN' THEN valuenum ELSE NULL END) AS albumin_max
  , min(CASE WHEN label = 'BANDS' THEN valuenum ELSE NULL END) AS bands_min
  , max(CASE WHEN label = 'BANDS' THEN valuenum ELSE NULL END) AS bands_max
  , min(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE NULL END) AS bicarbonate_min
  , max(CASE WHEN label = 'BICARBONATE' THEN valuenum ELSE NULL END) AS bicarbonate_max
  , min(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE NULL END) AS bilirubin_min
  , max(CASE WHEN label = 'BILIRUBIN' THEN valuenum ELSE NULL END) AS bilirubin_max
  , min(CASE WHEN label = 'CREATININE' THEN valuenum ELSE NULL END) AS creatinine_min
  , max(CASE WHEN label = 'CREATININE' THEN valuenum ELSE NULL END) AS creatinine_max
  , min(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE NULL END) AS chloride_min
  , max(CASE WHEN label = 'CHLORIDE' THEN valuenum ELSE NULL END) AS chloride_max
  , min(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE NULL END) AS glucose_min
  , max(CASE WHEN label = 'GLUCOSE' THEN valuenum ELSE NULL END) AS glucose_max
  , min(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE NULL END) AS hematocrit_min
  , max(CASE WHEN label = 'HEMATOCRIT' THEN valuenum ELSE NULL END) AS hematocrit_max
  , min(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE NULL END) AS hemoglobin_min
  , max(CASE WHEN label = 'HEMOGLOBIN' THEN valuenum ELSE NULL END) AS hemoglobin_max
  , min(CASE WHEN label = 'LACTATE' THEN valuenum ELSE NULL END) AS lactate_min
  , max(CASE WHEN label = 'LACTATE' THEN valuenum ELSE NULL END) AS lactate_max
  , min(CASE WHEN label = 'PLATELET' THEN valuenum ELSE NULL END) AS platelet_min
  , max(CASE WHEN label = 'PLATELET' THEN valuenum ELSE NULL END) AS platelet_max
  , min(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE NULL END) AS potassium_min
  , max(CASE WHEN label = 'POTASSIUM' THEN valuenum ELSE NULL END) AS potassium_max
  , min(CASE WHEN label = 'PTT' THEN valuenum ELSE NULL END) AS ptt_min
  , max(CASE WHEN label = 'PTT' THEN valuenum ELSE NULL END) AS ptt_max
  , min(CASE WHEN label = 'INR' THEN valuenum ELSE NULL END) AS inr_min
  , max(CASE WHEN label = 'INR' THEN valuenum ELSE NULL END) AS inr_max
  , min(CASE WHEN label = 'PT' THEN valuenum ELSE NULL END) AS pt_min
  , max(CASE WHEN label = 'PT' THEN valuenum ELSE NULL END) AS pt_max
  , min(CASE WHEN label = 'SODIUM' THEN valuenum ELSE NULL END) AS sodium_min
  , max(CASE WHEN label = 'SODIUM' THEN valuenum ELSE NULL END) AS sodium_max
  , min(CASE WHEN label = 'BUN' THEN valuenum ELSE NULL END) AS bun_min
  , max(CASE WHEN label = 'BUN' THEN valuenum ELSE NULL END) AS bun_max
  , min(CASE WHEN label = 'WBC' THEN valuenum ELSE NULL END) AS wbc_min
  , max(CASE WHEN label = 'WBC' THEN valuenum ELSE NULL END) AS wbc_max


FROM
( -- begin query that extracts the data
  SELECT ie.subject_id, ie.hadm_id, ie.icustay_id
  -- here we assign labels to ITEMIDs
  -- this also fuses together multiple ITEMIDs containing the same data
  , CASE
        WHEN itemid = 50868 THEN 'ANION GAP'
        WHEN itemid = 50862 THEN 'ALBUMIN'
        WHEN itemid = 51144 THEN 'BANDS'
        WHEN itemid = 50882 THEN 'BICARBONATE'
        WHEN itemid = 50885 THEN 'BILIRUBIN'
        WHEN itemid = 50912 THEN 'CREATININE'
        WHEN itemid = 50806 THEN 'CHLORIDE'
        WHEN itemid = 50902 THEN 'CHLORIDE'
        WHEN itemid = 50809 THEN 'GLUCOSE'
        WHEN itemid = 50931 THEN 'GLUCOSE'
        WHEN itemid = 50810 THEN 'HEMATOCRIT'
        WHEN itemid = 51221 THEN 'HEMATOCRIT'
        WHEN itemid = 50811 THEN 'HEMOGLOBIN'
        WHEN itemid = 51222 THEN 'HEMOGLOBIN'
        WHEN itemid = 50813 THEN 'LACTATE'
        WHEN itemid = 51265 THEN 'PLATELET'
        WHEN itemid = 50822 THEN 'POTASSIUM'
        WHEN itemid = 50971 THEN 'POTASSIUM'
        WHEN itemid = 51275 THEN 'PTT'
        WHEN itemid = 51237 THEN 'INR'
        WHEN itemid = 51274 THEN 'PT'
        WHEN itemid = 50824 THEN 'SODIUM'
        WHEN itemid = 50983 THEN 'SODIUM'
        WHEN itemid = 51006 THEN 'BUN'
        WHEN itemid = 51300 THEN 'WBC'
        WHEN itemid = 51301 THEN 'WBC'
      ELSE null
    END as label
  , -- add in some sanity checks on the values
  -- the where clause below requires all valuenum to be > 0, so these are only upper limit checks
    CASE
      WHEN itemid = 50862 and valuenum >    10 THEN null -- g/dL 'ALBUMIN'
      WHEN itemid = 50868 and valuenum > 10000 THEN null -- mEq/L 'ANION GAP'
      WHEN itemid = 51144 and valuenum <     0 THEN null -- immature band forms, %
      WHEN itemid = 51144 and valuenum >   100 THEN null -- immature band forms, %
      WHEN itemid = 50882 and valuenum > 10000 THEN null -- mEq/L 'BICARBONATE'
      WHEN itemid = 50885 and valuenum >   150 THEN null -- mg/dL 'BILIRUBIN'
      WHEN itemid = 50806 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50902 and valuenum > 10000 THEN null -- mEq/L 'CHLORIDE'
      WHEN itemid = 50912 and valuenum >   150 THEN null -- mg/dL 'CREATININE'
      WHEN itemid = 50809 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50931 and valuenum > 10000 THEN null -- mg/dL 'GLUCOSE'
      WHEN itemid = 50810 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 51221 and valuenum >   100 THEN null -- % 'HEMATOCRIT'
      WHEN itemid = 50811 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 51222 and valuenum >    50 THEN null -- g/dL 'HEMOGLOBIN'
      WHEN itemid = 50813 and valuenum >    50 THEN null -- mmol/L 'LACTATE'
      WHEN itemid = 51265 and valuenum > 10000 THEN null -- K/uL 'PLATELET'
      WHEN itemid = 50822 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 50971 and valuenum >    30 THEN null -- mEq/L 'POTASSIUM'
      WHEN itemid = 51275 and valuenum >   150 THEN null -- sec 'PTT'
      WHEN itemid = 51237 and valuenum >    50 THEN null -- 'INR'
      WHEN itemid = 51274 and valuenum >   150 THEN null -- sec 'PT'
      WHEN itemid = 50824 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 50983 and valuenum >   200 THEN null -- mEq/L == mmol/L 'SODIUM'
      WHEN itemid = 51006 and valuenum >   300 THEN null -- 'BUN'
      WHEN itemid = 51300 and valuenum >  1000 THEN null -- 'WBC'
      WHEN itemid = 51301 and valuenum >  1000 THEN null -- 'WBC'
    ELSE le.valuenum
    END as valuenum

  FROM icustays ie

  LEFT JOIN labevents le
    ON le.subject_id = ie.subject_id AND le.hadm_id = ie.hadm_id
    AND le.charttime BETWEEN (DATETIME_SUB(ie.intime, INTERVAL '6' HOUR)) AND (DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
    AND le.ITEMID in
    (
      -- comment is: LABEL | CATEGORY | FLUID | NUMBER OF ROWS IN LABEVENTS
      50868, -- ANION GAP | CHEMISTRY | BLOOD | 769895
      50862, -- ALBUMIN | CHEMISTRY | BLOOD | 146697
      51144, -- BANDS - hematology
      50882, -- BICARBONATE | CHEMISTRY | BLOOD | 780733
      50885, -- BILIRUBIN, TOTAL | CHEMISTRY | BLOOD | 238277
      50912, -- CREATININE | CHEMISTRY | BLOOD | 797476
      50902, -- CHLORIDE | CHEMISTRY | BLOOD | 795568
      50806, -- CHLORIDE, WHOLE BLOOD | BLOOD GAS | BLOOD | 48187
      50931, -- GLUCOSE | CHEMISTRY | BLOOD | 748981
      50809, -- GLUCOSE | BLOOD GAS | BLOOD | 196734
      51221, -- HEMATOCRIT | HEMATOLOGY | BLOOD | 881846
      50810, -- HEMATOCRIT, CALCULATED | BLOOD GAS | BLOOD | 89715
      51222, -- HEMOGLOBIN | HEMATOLOGY | BLOOD | 752523
      50811, -- HEMOGLOBIN | BLOOD GAS | BLOOD | 89712
      50813, -- LACTATE | BLOOD GAS | BLOOD | 187124
      51265, -- PLATELET COUNT | HEMATOLOGY | BLOOD | 778444
      50971, -- POTASSIUM | CHEMISTRY | BLOOD | 845825
      50822, -- POTASSIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 192946
      51275, -- PTT | HEMATOLOGY | BLOOD | 474937
      51237, -- INR(PT) | HEMATOLOGY | BLOOD | 471183
      51274, -- PT | HEMATOLOGY | BLOOD | 469090
      50983, -- SODIUM | CHEMISTRY | BLOOD | 808489
      50824, -- SODIUM, WHOLE BLOOD | BLOOD GAS | BLOOD | 71503
      51006, -- UREA NITROGEN | CHEMISTRY | BLOOD | 791925
      51301, -- WHITE BLOOD CELLS | HEMATOLOGY | BLOOD | 753301
      51300  -- WBC COUNT | HEMATOLOGY | BLOOD | 2371
    )
    AND valuenum IS NOT null AND valuenum > 0 -- lab values cannot be 0 and cannot be negative
) pvt
GROUP BY pvt.subject_id, pvt.hadm_id, pvt.icustay_id
ORDER BY pvt.subject_id, pvt.hadm_id, pvt.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:21.358 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,9,"CREATE TABLE AS",2022-07-29 16:01:20 PDT,3/2203,1924,LOG,00000,"duration: 1189.280 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.366 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,10,"idle in transaction",2022-07-29 16:01:20 PDT,3/2203,1924,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
alter table ""mimic"".""public"".""labs_first_day"" rename to ""labs_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:21.366 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,11,"ALTER TABLE",2022-07-29 16:01:20 PDT,3/2203,1924,LOG,00000,"duration: 0.358 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.375 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,12,"idle in transaction",2022-07-29 16:01:20 PDT,3/2203,1924,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
alter table ""mimic"".""public"".""labs_first_day__dbt_tmp"" rename to ""labs_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:21.375 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,13,"ALTER TABLE",2022-07-29 16:01:20 PDT,3/2203,1924,LOG,00000,"duration: 0.277 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.381 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,14,"idle in transaction",2022-07-29 16:01:20 PDT,3/2203,1924,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:21.386 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,15,"COMMIT",2022-07-29 16:01:20 PDT,3/0,0,LOG,00000,"duration: 5.433 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.390 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,16,"idle",2022-07-29 16:01:20 PDT,3/2204,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.labs_first_day""} */
drop table if exists ""mimic"".""public"".""labs_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:21.391 PDT,"ceci","mimic",64767,"localhost:51498",62e466c0.fcff,17,"DROP TABLE",2022-07-29 16:01:20 PDT,3/0,0,LOG,00000,"duration: 1.618 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.423 PDT,,,64776,"localhost:51506",62e466c1.fd08,1,"",2022-07-29 16:01:21 PDT,,0,LOG,00000,"connection received: host=localhost port=51506",,,,,,,,,""
2022-07-29 16:01:21.426 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,2,"authentication",2022-07-29 16:01:21 PDT,3/2205,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:21.427 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,3,"idle",2022-07-29 16:01:21 PDT,3/2206,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:21.427 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,4,"BEGIN",2022-07-29 16:01:21 PDT,3/2206,0,LOG,00000,"duration: 0.088 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.427 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,5,"idle in transaction",2022-07-29 16:01:21 PDT,3/2206,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:21.427 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,6,"BEGIN",2022-07-29 16:01:21 PDT,3/2206,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:21.427 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,7,"BEGIN",2022-07-29 16:01:21 PDT,3/2206,0,LOG,00000,"duration: 0.065 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.429 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,8,"idle in transaction",2022-07-29 16:01:21 PDT,3/2206,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */


  create  table ""mimic"".""public"".""rrt_first_day__dbt_tmp""
  as (
    -- determines if patients received any dialysis during their stay

-- Some example aggregate queries which summarize the data here..
-- This query estimates 6.7% of ICU patients received RRT.
    -- select count(rrt.icustay_id) as numobs
    -- , sum(rrt) as numrrt
    -- , sum(case when rrt=1 then 1 else 0 end)*100.0 / count(rrt.icustay_id)
    -- as percent_rrt
    -- from rrt
    -- inner join icustays ie on rrt.icustay_id = ie.icustay_id
    -- inner join patients p
    -- on rrt.subject_id = p.subject_id
    -- and p.dob < ie.intime - interval '1' year
    -- inner join admissions adm
    -- on rrt.hadm_id = adm.hadm_id

-- This query estimates that 4.6% of first ICU stays received RRT.
    -- select
    --   count(rrt.icustay_id) as numobs
    --   , sum(rrt) as numrrt
    --   , sum(case when rrt=1 then 1 else 0 end)*100.0 / count(rrt.icustay_id)
    -- as percent_rrt
    -- from
    -- (
    -- select ie.icustay_id, rrt.rrt
    --   , ROW_NUMBER() over (partition by ie.subject_id order by ie.intime) rn
    -- from rrt
    -- inner join icustays ie
    --   on rrt.icustay_id = ie.icustay_id
    -- inner join patients p
    --   on rrt.subject_id = p.subject_id
    -- and p.dob < ie.intime - interval '1' year
    -- inner join admissions adm
    --   on rrt.hadm_id = adm.hadm_id
    -- ) rrt
    -- where rn = 1

with cv as
(
  select ie.icustay_id
    , max(
        case
          when ce.itemid in (152,148,149,146,147,151,150) and value is not null then 1
          when ce.itemid in (229,235,241,247,253,259,265,271) and value = 'Dialysis Line' then 1
          when ce.itemid = 582 and value in ('CAVH Start','CAVH D/C','CVVHD Start','CVVHD D/C','Hemodialysis st','Hemodialysis end') then 1
        else 0 end
        ) as RRT
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.itemid in
    (
       152 -- ""Dialysis Type""61449
      ,148 -- ""Dialysis Access Site""60335
      ,149 -- ""Dialysis Access Type""60030
      ,146 -- ""Dialysate Flow ml/hr""57445
      ,147 -- ""Dialysate Infusing""56605
      ,151 -- ""Dialysis Site Appear""37345
      ,150 -- ""Dialysis Machine""27472
      ,229 -- INV Line#1 [Type]
      ,235 -- INV Line#2 [Type]
      ,241 -- INV Line#3 [Type]
      ,247 -- INV Line#4 [Type]
      ,253 -- INV Line#5 [Type]
      ,259 -- INV Line#6 [Type]
      ,265 -- INV Line#7 [Type]
      ,271 -- INV Line#8 [Type]
      ,582 -- Procedures
    )
    and ce.value is not null
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
  where ie.dbsource = 'carevue'
  group by ie.icustay_id
)
, mv_ce as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join chartevents ce
    on ie.icustay_id = ce.icustay_id
    and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
      -- Checkboxes
        226118 -- | Dialysis Catheter placed in outside facility      | Access Lines - Invasive | chartevents        | Checkbox
      , 227357 -- | Dialysis Catheter Dressing Occlusive              | Access Lines - Invasive | chartevents        | Checkbox
      , 225725 -- | Dialysis Catheter Tip Cultured                    | Access Lines - Invasive | chartevents        | Checkbox
      -- Numeric values
      , 226499 -- | Hemodialysis Output                               | Dialysis                | chartevents        | Numeric
      , 224154 -- | Dialysate Rate                                    | Dialysis                | chartevents        | Numeric
      , 225810 -- | Dwell Time (Peritoneal Dialysis)                  | Dialysis                | chartevents        | Numeric
      , 227639 -- | Medication Added Amount  #2 (Peritoneal Dialysis) | Dialysis                | chartevents        | Numeric
      , 225183 -- | Current Goal                     | Dialysis | chartevents        | Numeric
      , 227438 -- | Volume not removed               | Dialysis | chartevents        | Numeric
      , 224191 -- | Hourly Patient Fluid Removal     | Dialysis | chartevents        | Numeric
      , 225806 -- | Volume In (PD)                   | Dialysis | chartevents        | Numeric
      , 225807 -- | Volume Out (PD)                  | Dialysis | chartevents        | Numeric
      , 228004 -- | Citrate (ACD-A)                  | Dialysis | chartevents        | Numeric
      , 228005 -- | PBP (Prefilter) Replacement Rate | Dialysis | chartevents        | Numeric
      , 228006 -- | Post Filter Replacement Rate     | Dialysis | chartevents        | Numeric
      , 224144 -- | Blood Flow (ml/min)              | Dialysis | chartevents        | Numeric
      , 224145 -- | Heparin Dose (per hour)          | Dialysis | chartevents        | Numeric
      , 224149 -- | Access Pressure                  | Dialysis | chartevents        | Numeric
      , 224150 -- | Filter Pressure                  | Dialysis | chartevents        | Numeric
      , 224151 -- | Effluent Pressure                | Dialysis | chartevents        | Numeric
      , 224152 -- | Return Pressure                  | Dialysis | chartevents        | Numeric
      , 224153 -- | Replacement Rate                 | Dialysis | chartevents        | Numeric
      , 224404 -- | ART Lumen Volume                 | Dialysis | chartevents        | Numeric
      , 224406 -- | VEN Lumen Volume                 | Dialysis | chartevents        | Numeric
      , 226457 -- | Ultrafiltrate Output             | Dialysis | chartevents        | Numeric
    )
    and valuenum > 0 -- also ensures it's not null
  group by ie.icustay_id
)
, mv_ie as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join inputevents_mv tt
    on ie.icustay_id = tt.icustay_id
    and tt.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
        227536 --	KCl (CRRT)	Medications	inputevents_mv	Solution
      , 227525 --	Calcium Gluconate (CRRT)	Medications	inputevents_mv	Solution
    )
    and amount > 0 -- also ensures it's not null
  group by ie.icustay_id
)
, mv_de as
(
  select ie.icustay_id
    , 1 as RRT
  FROM icustays ie
  inner join datetimeevents tt
    on ie.icustay_id = tt.icustay_id
    and tt.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    and itemid in
    (
      -- TODO: unsure how to handle ""Last dialysis""
      --  225128 -- | Last dialysis                                     | Adm History/FHPA        | datetimeevents     | Date time
        225318 -- | Dialysis Catheter Cap Change                      | Access Lines - Invasive | datetimeevents     | Date time
      , 225319 -- | Dialysis Catheter Change over Wire Date           | Access Lines - Invasive | datetimeevents     | Date time
      , 225321 -- | Dialysis Catheter Dressing Change                 | Access Lines - Invasive | datetimeevents     | Date time
      , 225322 -- | Dialysis Catheter Insertion Date                  | Access Lines - Invasive | datetimeevents     | Date time
      , 225324 -- | Dialysis CatheterTubing Change                    | Access Lines - Invasive | datetimeevents     | Date time
    )
  group by ie.icustay_id
)
, mv_pe as
(
    select ie.icustay_id
      , 1 as RRT
    FROM icustays ie
    inner join procedureevents_mv tt
      on ie.icustay_id = tt.icustay_id
      and tt.starttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
      and itemid in
      (
          225441 -- | Hemodialysis                                      | 4-Procedures            | procedureevents_mv | Process
        , 225802 -- | Dialysis - CRRT                                   | Dialysis                | procedureevents_mv | Process
        , 225803 -- | Dialysis - CVVHD                                  | Dialysis                | procedureevents_mv | Process
        , 225805 -- | Peritoneal Dialysis                               | Dialysis                | procedureevents_mv | Process
        , 224270 -- | Dialysis Catheter                                 | Access Lines - Invasive | procedureevents_mv | Process
        , 225809 -- | Dialysis - CVVHDF                                 | Dialysis                | procedureevents_mv | Process
        , 225955 -- | Dialysis - SCUF                                   | Dialysis                | procedureevents_mv | Process
        , 225436 -- | CRRT Filter Change               | Dialysis | procedureevents_mv | Process
      )
    group by ie.icustay_id
)
select ie.subject_id, ie.hadm_id, ie.icustay_id
  , case
      when cv.RRT = 1 then 1
      when mv_ce.RRT = 1 then 1
      when mv_ie.RRT = 1 then 1
      when mv_de.RRT = 1 then 1
      when mv_pe.RRT = 1 then 1
      else 0
    end as rrt
FROM icustays ie
left join cv
  on ie.icustay_id = cv.icustay_id
left join mv_ce
  on ie.icustay_id = mv_ce.icustay_id
left join mv_ie
  on ie.icustay_id = mv_ie.icustay_id
left join mv_de
  on ie.icustay_id = mv_de.icustay_id
left join mv_pe
  on ie.icustay_id = mv_pe.icustay_id
order by ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:21.707 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,9,"CREATE TABLE AS",2022-07-29 16:01:21 PDT,3/2206,1926,LOG,00000,"duration: 277.942 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.718 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,10,"idle in transaction",2022-07-29 16:01:21 PDT,3/2206,1926,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
alter table ""mimic"".""public"".""rrt_first_day"" rename to ""rrt_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:21.718 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,11,"ALTER TABLE",2022-07-29 16:01:21 PDT,3/2206,1926,LOG,00000,"duration: 0.310 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.723 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,12,"idle in transaction",2022-07-29 16:01:21 PDT,3/2206,1926,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
alter table ""mimic"".""public"".""rrt_first_day__dbt_tmp"" rename to ""rrt_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:21.723 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,13,"ALTER TABLE",2022-07-29 16:01:21 PDT,3/2206,1926,LOG,00000,"duration: 0.307 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.728 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,14,"idle in transaction",2022-07-29 16:01:21 PDT,3/2206,1926,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:21.733 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,15,"COMMIT",2022-07-29 16:01:21 PDT,3/0,0,LOG,00000,"duration: 5.357 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.736 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,16,"idle",2022-07-29 16:01:21 PDT,3/2207,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.rrt_first_day""} */
drop table if exists ""mimic"".""public"".""rrt_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:21.738 PDT,"ceci","mimic",64776,"localhost:51506",62e466c1.fd08,17,"DROP TABLE",2022-07-29 16:01:21 PDT,3/0,0,LOG,00000,"duration: 1.374 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.763 PDT,,,64777,"localhost:51508",62e466c1.fd09,1,"",2022-07-29 16:01:21 PDT,,0,LOG,00000,"connection received: host=localhost port=51508",,,,,,,,,""
2022-07-29 16:01:21.768 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,2,"authentication",2022-07-29 16:01:21 PDT,3/2208,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:21.770 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,3,"idle",2022-07-29 16:01:21 PDT,3/2209,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:21.770 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,4,"BEGIN",2022-07-29 16:01:21 PDT,3/2209,0,LOG,00000,"duration: 0.099 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.770 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,5,"idle in transaction",2022-07-29 16:01:21 PDT,3/2209,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:21.770 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,6,"BEGIN",2022-07-29 16:01:21 PDT,3/2209,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:21.770 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,7,"BEGIN",2022-07-29 16:01:21 PDT,3/2209,0,LOG,00000,"duration: 0.115 ms",,,,,,,,,"dbt"
2022-07-29 16:01:21.773 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,8,"idle in transaction",2022-07-29 16:01:21 PDT,3/2209,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */


  create  table ""mimic"".""public"".""urine_output_first_day__dbt_tmp""
  as (
    -- ------------------------------------------------------------------
-- Purpose: Create a view of the urine output for each ICUSTAY_ID over the first 24 hours.
-- ------------------------------------------------------------------

select
  -- patient identifiers
  ie.subject_id, ie.hadm_id, ie.icustay_id

  -- volumes associated with urine output ITEMIDs
  , sum(
      -- we consider input of GU irrigant as a negative volume
      case
        when oe.itemid = 227488 and oe.value > 0 then -1*oe.value
        else oe.value
    end) as urineoutput
FROM icustays ie
-- Join to the outputevents table to get urine output
left join outputevents oe
-- join on all patient identifiers
on ie.subject_id = oe.subject_id and ie.hadm_id = oe.hadm_id and ie.icustay_id = oe.icustay_id
-- and ensure the data occurs during the first day
and oe.charttime between ie.intime and (DATETIME_ADD(ie.intime, INTERVAL '1' DAY)) -- first ICU day
where itemid in
(
-- these are the most frequently occurring urine output observations in CareVue
40055, -- ""Urine Out Foley""
43175, -- ""Urine .""
40069, -- ""Urine Out Void""
40094, -- ""Urine Out Condom Cath""
40715, -- ""Urine Out Suprapubic""
40473, -- ""Urine Out IleoConduit""
40085, -- ""Urine Out Incontinent""
40057, -- ""Urine Out Rt Nephrostomy""
40056, -- ""Urine Out Lt Nephrostomy""
40405, -- ""Urine Out Other""
40428, -- ""Urine Out Straight Cath""
40086,--	Urine Out Incontinent
40096, -- ""Urine Out Ureteral Stent #1""
40651, -- ""Urine Out Ureteral Stent #2""

-- these are the most frequently occurring urine output observations in MetaVision
226559, -- ""Foley""
226560, -- ""Void""
226561, -- ""Condom Cath""
226584, -- ""Ileoconduit""
226563, -- ""Suprapubic""
226564, -- ""R Nephrostomy""
226565, -- ""L Nephrostomy""
226567, --	Straight Cath
226557, -- R Ureteral Stent
226558, -- L Ureteral Stent
227488, -- GU Irrigant Volume In
227489  -- GU Irrigant/Urine Volume Out
)
group by ie.subject_id, ie.hadm_id, ie.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:24.879 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,9,"CREATE TABLE AS",2022-07-29 16:01:21 PDT,3/2209,1928,LOG,00000,"duration: 3106.473 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.885 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,10,"idle in transaction",2022-07-29 16:01:21 PDT,3/2209,1928,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
alter table ""mimic"".""public"".""urine_output_first_day"" rename to ""urine_output_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:24.886 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,11,"ALTER TABLE",2022-07-29 16:01:21 PDT,3/2209,1928,LOG,00000,"duration: 0.300 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.892 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,12,"idle in transaction",2022-07-29 16:01:21 PDT,3/2209,1928,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
alter table ""mimic"".""public"".""urine_output_first_day__dbt_tmp"" rename to ""urine_output_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:24.892 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,13,"ALTER TABLE",2022-07-29 16:01:21 PDT,3/2209,1928,LOG,00000,"duration: 0.285 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.897 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,14,"idle in transaction",2022-07-29 16:01:21 PDT,3/2209,1928,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:24.901 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,15,"COMMIT",2022-07-29 16:01:21 PDT,3/0,0,LOG,00000,"duration: 4.325 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.905 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,16,"idle",2022-07-29 16:01:21 PDT,3/2210,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.urine_output_first_day""} */
drop table if exists ""mimic"".""public"".""urine_output_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:24.907 PDT,"ceci","mimic",64777,"localhost:51508",62e466c1.fd09,17,"DROP TABLE",2022-07-29 16:01:21 PDT,3/0,0,LOG,00000,"duration: 1.603 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.938 PDT,,,64799,"localhost:51516",62e466c4.fd1f,1,"",2022-07-29 16:01:24 PDT,,0,LOG,00000,"connection received: host=localhost port=51516",,,,,,,,,""
2022-07-29 16:01:24.944 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,2,"authentication",2022-07-29 16:01:24 PDT,3/2211,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:24.946 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,3,"idle",2022-07-29 16:01:24 PDT,3/2212,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:24.946 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,4,"BEGIN",2022-07-29 16:01:24 PDT,3/2212,0,LOG,00000,"duration: 0.103 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.946 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,5,"idle in transaction",2022-07-29 16:01:24 PDT,3/2212,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:24.946 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,6,"BEGIN",2022-07-29 16:01:24 PDT,3/2212,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:24.946 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,7,"BEGIN",2022-07-29 16:01:24 PDT,3/2212,0,LOG,00000,"duration: 0.022 ms",,,,,,,,,"dbt"
2022-07-29 16:01:24.948 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,8,"idle in transaction",2022-07-29 16:01:24 PDT,3/2212,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */


  create  table ""mimic"".""public"".""ventilation_first_day__dbt_tmp""
  as (
    -- Determines if a patient is ventilated on the first day of their ICU stay.
-- Creates a table with the result.
-- Requires the ventilation_durations table, generated by ../ventilation-durations.sql

select
  ie.subject_id, ie.hadm_id, ie.icustay_id
  -- if vd.icustay_id is not null, then they have a valid ventilation event
  -- in this case, we say they are ventilated
  -- otherwise, they are not
  , max(case
      when vd.icustay_id is not null then 1
    else 0 end) as vent
FROM icustays ie
left join ""mimic"".""public"".""ventilation_durations"" vd
  on ie.icustay_id = vd.icustay_id
  and
  (
    -- ventilation duration overlaps with ICU admission -> vented on admission
    (vd.starttime <= ie.intime and vd.endtime >= ie.intime)
    -- ventilation started during the first day
    OR (vd.starttime >= ie.intime and vd.starttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY))
  )
group by ie.subject_id, ie.hadm_id, ie.icustay_id
order by ie.subject_id, ie.hadm_id, ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:25.071 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,9,"CREATE TABLE AS",2022-07-29 16:01:24 PDT,3/2212,1930,LOG,00000,"duration: 122.703 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.079 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,10,"idle in transaction",2022-07-29 16:01:24 PDT,3/2212,1930,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
alter table ""mimic"".""public"".""ventilation_first_day"" rename to ""ventilation_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:25.079 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,11,"ALTER TABLE",2022-07-29 16:01:24 PDT,3/2212,1930,LOG,00000,"duration: 0.421 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.086 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,12,"idle in transaction",2022-07-29 16:01:24 PDT,3/2212,1930,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
alter table ""mimic"".""public"".""ventilation_first_day__dbt_tmp"" rename to ""ventilation_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:25.086 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,13,"ALTER TABLE",2022-07-29 16:01:24 PDT,3/2212,1930,LOG,00000,"duration: 0.246 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.090 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,14,"idle in transaction",2022-07-29 16:01:24 PDT,3/2212,1930,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:25.094 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,15,"COMMIT",2022-07-29 16:01:24 PDT,3/0,0,LOG,00000,"duration: 3.829 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.097 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,16,"idle",2022-07-29 16:01:24 PDT,3/2213,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.ventilation_first_day""} */
drop table if exists ""mimic"".""public"".""ventilation_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:25.098 PDT,"ceci","mimic",64799,"localhost:51516",62e466c4.fd1f,17,"DROP TABLE",2022-07-29 16:01:24 PDT,3/0,0,LOG,00000,"duration: 1.488 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.131 PDT,,,64800,"localhost:51518",62e466c5.fd20,1,"",2022-07-29 16:01:25 PDT,,0,LOG,00000,"connection received: host=localhost port=51518",,,,,,,,,""
2022-07-29 16:01:25.135 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,2,"authentication",2022-07-29 16:01:25 PDT,3/2214,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:25.136 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,3,"idle",2022-07-29 16:01:25 PDT,3/2215,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.136 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,4,"BEGIN",2022-07-29 16:01:25 PDT,3/2215,0,LOG,00000,"duration: 0.070 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.136 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,5,"idle in transaction",2022-07-29 16:01:25 PDT,3/2215,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.136 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,6,"BEGIN",2022-07-29 16:01:25 PDT,3/2215,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:25.136 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,7,"BEGIN",2022-07-29 16:01:25 PDT,3/2215,0,LOG,00000,"duration: 0.022 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.139 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,8,"idle in transaction",2022-07-29 16:01:25 PDT,3/2215,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */


  create  table ""mimic"".""public"".""vitals_first_day__dbt_tmp""
  as (
    -- This query pivots the vital signs for the first 24 hours of a patient's stay
-- Vital signs include heart rate, blood pressure, respiration rate, and temperature

SELECT pvt.subject_id, pvt.hadm_id, pvt.icustay_id

-- Easier names
, min(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_min
, max(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_max
, avg(case when VitalID = 1 then valuenum ELSE NULL END) AS heartrate_mean
, min(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_min
, max(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_max
, avg(case when VitalID = 2 then valuenum ELSE NULL END) AS sysbp_mean
, min(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_min
, max(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_max
, avg(case when VitalID = 3 then valuenum ELSE NULL END) AS diasbp_mean
, min(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_min
, max(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_max
, avg(case when VitalID = 4 then valuenum ELSE NULL END) AS meanbp_mean
, min(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_min
, max(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_max
, avg(case when VitalID = 5 then valuenum ELSE NULL END) AS resprate_mean
, min(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_min
, max(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_max
, avg(case when VitalID = 6 then valuenum ELSE NULL END) AS tempc_mean
, min(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_min
, max(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_max
, avg(case when VitalID = 7 then valuenum ELSE NULL END) AS spo2_mean
, min(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_min
, max(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_max
, avg(case when VitalID = 8 then valuenum ELSE NULL END) AS glucose_mean

FROM  (
  select ie.subject_id, ie.hadm_id, ie.icustay_id
  , case
    when itemid in (211,220045) and valuenum > 0 and valuenum < 300 then 1 -- HeartRate
    when itemid in (51,442,455,6701,220179,220050) and valuenum > 0 and valuenum < 400 then 2 -- SysBP
    when itemid in (8368,8440,8441,8555,220180,220051) and valuenum > 0 and valuenum < 300 then 3 -- DiasBP
    when itemid in (456,52,6702,443,220052,220181,225312) and valuenum > 0 and valuenum < 300 then 4 -- MeanBP
    when itemid in (615,618,220210,224690) and valuenum > 0 and valuenum < 70 then 5 -- RespRate
    when itemid in (223761,678) and valuenum > 70 and valuenum < 120  then 6 -- TempF, converted to degC in valuenum call
    when itemid in (223762,676) and valuenum > 10 and valuenum < 50  then 6 -- TempC
    when itemid in (646,220277) and valuenum > 0 and valuenum <= 100 then 7 -- SpO2
    when itemid in (807,811,1529,3745,3744,225664,220621,226537) and valuenum > 0 then 8 -- Glucose

    else null end as vitalid
      -- convert F to C
  , case when itemid in (223761,678) then (valuenum-32)/1.8 else valuenum end as valuenum

  from icustays ie
  left join chartevents ce
  on ie.icustay_id = ce.icustay_id
  and ce.charttime between ie.intime and DATETIME_ADD(ie.intime, INTERVAL '1 DAY')
  and DATETIME_DIFF(ce.charttime, ie.intime, 'SECOND') > 0
  and DATETIME_DIFF(ce.charttime, ie.intime, 'HOUR') <= 24
  -- exclude rows marked as error
  and (ce.error IS NULL or ce.error = 0)
  where ce.itemid in
  (
  -- HEART RATE
  211, --""Heart Rate""
  220045, --""Heart Rate""

  -- Systolic/diastolic

  51, --	Arterial BP [Systolic]
  442, --	Manual BP [Systolic]
  455, --	NBP [Systolic]
  6701, --	Arterial BP #2 [Systolic]
  220179, --	Non Invasive Blood Pressure systolic
  220050, --	Arterial Blood Pressure systolic

  8368, --	Arterial BP [Diastolic]
  8440, --	Manual BP [Diastolic]
  8441, --	NBP [Diastolic]
  8555, --	Arterial BP #2 [Diastolic]
  220180, --	Non Invasive Blood Pressure diastolic
  220051, --	Arterial Blood Pressure diastolic


  -- MEAN ARTERIAL PRESSURE
  456, --""NBP Mean""
  52, --""Arterial BP Mean""
  6702, --	Arterial BP Mean #2
  443, --	Manual BP Mean(calc)
  220052, --""Arterial Blood Pressure mean""
  220181, --""Non Invasive Blood Pressure mean""
  225312, --""ART BP mean""

  -- RESPIRATORY RATE
  618,--	Respiratory Rate
  615,--	Resp Rate (Total)
  220210,--	Respiratory Rate
  224690, --	Respiratory Rate (Total)


  -- SPO2, peripheral
  646, 220277,

  -- GLUCOSE, both lab and fingerstick
  807,--	Fingerstick Glucose
  811,--	Glucose (70-105)
  1529,--	Glucose
  3745,--	BloodGlucose
  3744,--	Blood Glucose
  225664,--	Glucose finger stick
  220621,--	Glucose (serum)
  226537,--	Glucose (whole blood)

  -- TEMPERATURE
  223762, -- ""Temperature Celsius""
  676,	-- ""Temperature C""
  223761, -- ""Temperature Fahrenheit""
  678 --	""Temperature F""

  )
) pvt
group by pvt.subject_id, pvt.hadm_id, pvt.icustay_id
order by pvt.subject_id, pvt.hadm_id, pvt.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:25.164 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,9,"CREATE TABLE AS",2022-07-29 16:01:25 PDT,3/2215,1932,LOG,00000,"duration: 25.477 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.175 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,10,"idle in transaction",2022-07-29 16:01:25 PDT,3/2215,1932,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
alter table ""mimic"".""public"".""vitals_first_day"" rename to ""vitals_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:25.176 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,11,"ALTER TABLE",2022-07-29 16:01:25 PDT,3/2215,1932,LOG,00000,"duration: 0.452 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.189 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,12,"idle in transaction",2022-07-29 16:01:25 PDT,3/2215,1932,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
alter table ""mimic"".""public"".""vitals_first_day__dbt_tmp"" rename to ""vitals_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:25.189 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,13,"ALTER TABLE",2022-07-29 16:01:25 PDT,3/2215,1932,LOG,00000,"duration: 0.403 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.201 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,14,"idle in transaction",2022-07-29 16:01:25 PDT,3/2215,1932,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:25.203 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,15,"COMMIT",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 2.049 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.208 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,16,"idle",2022-07-29 16:01:25 PDT,3/2216,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.vitals_first_day""} */
drop table if exists ""mimic"".""public"".""vitals_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:25.210 PDT,"ceci","mimic",64800,"localhost:51518",62e466c5.fd20,17,"DROP TABLE",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 1.866 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.246 PDT,,,64801,"localhost:51520",62e466c5.fd21,1,"",2022-07-29 16:01:25 PDT,,0,LOG,00000,"connection received: host=localhost port=51520",,,,,,,,,""
2022-07-29 16:01:25.251 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,2,"authentication",2022-07-29 16:01:25 PDT,3/2217,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:25.254 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,3,"idle",2022-07-29 16:01:25 PDT,3/2218,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.254 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,4,"BEGIN",2022-07-29 16:01:25 PDT,3/2218,0,LOG,00000,"duration: 0.721 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.254 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,5,"idle in transaction",2022-07-29 16:01:25 PDT,3/2218,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.254 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,6,"BEGIN",2022-07-29 16:01:25 PDT,3/2218,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:25.255 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,7,"BEGIN",2022-07-29 16:01:25 PDT,3/2218,0,LOG,00000,"duration: 0.220 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.257 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,8,"idle in transaction",2022-07-29 16:01:25 PDT,3/2218,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */


  create  table ""mimic"".""public"".""weight_first_day__dbt_tmp""
  as (
    -- This query extracts weights for adult ICU patients on their first ICU day.
-- It does *not* use any information after the first ICU day, as weight is
-- sometimes used to monitor fluid balance.

-- ** Requires the echodata view, generated by concepts/echo-data.sql

with ce as
(
    SELECT
      c.icustay_id
      -- we take the avg value from roughly first day
      -- TODO: eliminate obvious outliers if there is a reasonable weight
      -- (e.g. weight of 180kg and 90kg would remove 180kg instead of taking the median)
      , AVG(VALUENUM) as Weight_Admit
    FROM chartevents c
    inner join icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (762,226512) -- Admit Wt
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
    group by c.icustay_id
)
, dwt as
(
    SELECT
      c.icustay_id
      , AVG(VALUENUM) as Weight_Daily
    FROM chartevents c
    INNER JOIN icustays ie
        on c.icustay_id = ie.icustay_id
        and c.charttime <= DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
        and c.charttime > DATETIME_SUB(ie.intime, INTERVAL '1' DAY) -- some fuzziness for admit time
    WHERE c.valuenum IS NOT NULL
    AND c.itemid in (763,224639) -- Daily Weight
    AND c.valuenum != 0
    -- exclude rows marked as error
    AND (c.error IS NULL OR c.error = 0)
    group by c.icustay_id
)
-- we split in-hospital/out of hospital echoes as we would like to prioritize in-hospital data
, echo_hadm as
(
    select
        ie.icustay_id
        , 0.453592*AVG(weight) as Weight_EchoInHosp
    from ""mimic"".""public"".""echo_data"" ec
    inner join icustays ie
        on ec.hadm_id = ie.hadm_id
        and ec.charttime < DATETIME_ADD(ie.intime, INTERVAL '1' DAY)
    where
            ec.HADM_ID is not null
        and ec.weight is not null
    group by ie.icustay_id
)
, echo_nohadm as
(
    select
        ie.icustay_id
        , 0.453592*AVG(weight) as Weight_EchoPreHosp
    from ""mimic"".""public"".""echo_data"" ec
    inner join icustays ie
        on ie.subject_id = ec.subject_id
        and ie.intime < DATETIME_ADD(ec.charttime, INTERVAL '1' MONTH)
        and ie.intime > ec.charttime
    where
            ec.HADM_ID is null
        and ec.weight is not null
    group by ie.icustay_id
)
select
    ie.icustay_id
    , round(cast(
    case
        when ce.icustay_id is not null
            then ce.Weight_Admit
        when dwt.icustay_id is not null
            then dwt.Weight_Daily
        when eh.icustay_id is not null
            then eh.Weight_EchoInHosp
        when enh.icustay_id is not null
            then enh.Weight_EchoPreHosp
        else null end
        as numeric), 2)
    as weight

    -- components
    , ce.weight_admit
    , dwt.weight_daily
    , eh.weight_echoinhosp
    , enh.weight_echoprehosp

FROM icustays ie

-- filter to only adults
inner join patients pat
    on ie.subject_id = pat.subject_id
    and ie.intime > DATETIME_ADD(pat.dob, INTERVAL '1' YEAR)

-- admission weight
left join ce
    on ie.icustay_id = ce.icustay_id

-- daily weights
left join dwt
    on ie.icustay_id = dwt.icustay_id

-- in-hospital echo weight
left join echo_hadm eh
    on ie.icustay_id = eh.icustay_id

-- pre-hospitalization echo weights
left join echo_nohadm enh
    on ie.icustay_id = enh.icustay_id
order by ie.icustay_id
  );",,,,,,,,,"dbt"
2022-07-29 16:01:25.400 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,9,"CREATE TABLE AS",2022-07-29 16:01:25 PDT,3/2218,1934,LOG,00000,"duration: 143.598 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.408 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,10,"idle in transaction",2022-07-29 16:01:25 PDT,3/2218,1934,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
alter table ""mimic"".""public"".""weight_first_day"" rename to ""weight_first_day__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:25.408 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,11,"ALTER TABLE",2022-07-29 16:01:25 PDT,3/2218,1934,LOG,00000,"duration: 0.244 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.414 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,12,"idle in transaction",2022-07-29 16:01:25 PDT,3/2218,1934,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
alter table ""mimic"".""public"".""weight_first_day__dbt_tmp"" rename to ""weight_first_day""",,,,,,,,,"dbt"
2022-07-29 16:01:25.414 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,13,"ALTER TABLE",2022-07-29 16:01:25 PDT,3/2218,1934,LOG,00000,"duration: 0.232 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.418 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,14,"idle in transaction",2022-07-29 16:01:25 PDT,3/2218,1934,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:25.425 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,15,"COMMIT",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 6.189 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.428 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,16,"idle",2022-07-29 16:01:25 PDT,3/2219,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.weight_first_day""} */
drop table if exists ""mimic"".""public"".""weight_first_day__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:25.430 PDT,"ceci","mimic",64801,"localhost:51520",62e466c5.fd21,17,"DROP TABLE",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 1.581 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.463 PDT,,,64803,"localhost:51524",62e466c5.fd23,1,"",2022-07-29 16:01:25 PDT,,0,LOG,00000,"connection received: host=localhost port=51524",,,,,,,,,""
2022-07-29 16:01:25.468 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,2,"authentication",2022-07-29 16:01:25 PDT,3/2220,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:25.469 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,3,"idle",2022-07-29 16:01:25 PDT,3/2221,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.469 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,4,"BEGIN",2022-07-29 16:01:25 PDT,3/2221,0,LOG,00000,"duration: 0.124 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.469 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,5,"idle in transaction",2022-07-29 16:01:25 PDT,3/2221,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.469 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,6,"BEGIN",2022-07-29 16:01:25 PDT,3/2221,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:25.469 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,7,"BEGIN",2022-07-29 16:01:25 PDT,3/2221,0,LOG,00000,"duration: 0.030 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.472 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,8,"idle in transaction",2022-07-29 16:01:25 PDT,3/2221,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */


  create  table ""mimic"".""public"".""blood_gas_first_day_arterial__dbt_tmp""
  as (
    with stg_spo2 as
(
  select subject_id, hadm_id, icustay_id, charttime
    -- max here is just used to group SpO2 by charttime
    , max(case when valuenum <= 0 or valuenum > 100 then null else valuenum end) as SpO2
  FROM chartevents
  -- o2 sat
  where ITEMID in
  (
    646 -- SpO2
  , 220277 -- O2 saturation pulseoxymetry
  )
  group by subject_id, hadm_id, icustay_id, charttime
)
, stg_fio2 as
(
  select subject_id, hadm_id, icustay_id, charttime
    -- pre-process the FiO2s to ensure they are between 21-100%
    , max(
        case
          when itemid = 223835
            then case
              when valuenum > 0 and valuenum <= 1
                then valuenum * 100
              -- improperly input data - looks like O2 flow in litres
              when valuenum > 1 and valuenum < 21
                then null
              when valuenum >= 21 and valuenum <= 100
                then valuenum
              else null end -- unphysiological
        when itemid in (3420, 3422)
        -- all these values are well formatted
            then valuenum
        when itemid = 190 and valuenum > 0.20 and valuenum < 1
        -- well formatted but not in %
            then valuenum * 100
      else null end
    ) as fio2_chartevents
  FROM chartevents
  where ITEMID in
  (
    3420 -- FiO2
  , 190 -- FiO2 set
  , 223835 -- Inspired O2 Fraction (FiO2)
  , 3422 -- FiO2 [measured]
  )
  -- exclude rows marked as error
  AND (error IS NULL OR error = 0)
  group by subject_id, hadm_id, icustay_id, charttime
)
, stg2 as
(
select bg.*
  , ROW_NUMBER() OVER (partition by bg.icustay_id, bg.charttime order by s1.charttime DESC) as lastRowSpO2
  , s1.spo2
from ""mimic"".""public"".""blood_gas_first_day"" bg
left join stg_spo2 s1
  -- same patient
  on  bg.icustay_id = s1.icustay_id
  -- spo2 occurred at most 2 hours before this blood gas
  and s1.charttime >= DATETIME_SUB(bg.charttime, INTERVAL '2' HOUR)
  and s1.charttime <= bg.charttime
where bg.po2 is not null
)
, stg3 as
(
select bg.*
  , ROW_NUMBER() OVER (partition by bg.icustay_id, bg.charttime order by s2.charttime DESC) as lastRowFiO2
  , s2.fio2_chartevents

  -- create our specimen prediction
  ,  1/(1+exp(-(-0.02544
  +    0.04598 * po2
  + coalesce(-0.15356 * spo2             , -0.15356 *   97.49420 +    0.13429)
  + coalesce( 0.00621 * fio2_chartevents ,  0.00621 *   51.49550 +   -0.24958)
  + coalesce( 0.10559 * hemoglobin       ,  0.10559 *   10.32307 +    0.05954)
  + coalesce( 0.13251 * so2              ,  0.13251 *   93.66539 +   -0.23172)
  + coalesce(-0.01511 * pco2             , -0.01511 *   42.08866 +   -0.01630)
  + coalesce( 0.01480 * fio2             ,  0.01480 *   63.97836 +   -0.31142)
  + coalesce(-0.00200 * aado2            , -0.00200 *  442.21186 +   -0.01328)
  + coalesce(-0.03220 * bicarbonate      , -0.03220 *   22.96894 +   -0.06535)
  + coalesce( 0.05384 * totalco2         ,  0.05384 *   24.72632 +   -0.01405)
  + coalesce( 0.08202 * lactate          ,  0.08202 *    3.06436 +    0.06038)
  + coalesce( 0.10956 * ph               ,  0.10956 *    7.36233 +   -0.00617)
  + coalesce( 0.00848 * o2flow           ,  0.00848 *    7.59362 +   -0.35803)
  ))) as SPECIMEN_PROB
from stg2 bg
left join stg_fio2 s2
  -- same patient
  on  bg.icustay_id = s2.icustay_id
  -- fio2 occurred at most 4 hours before this blood gas
  and s2.charttime between DATETIME_SUB(bg.charttime, INTERVAL '4' HOUR) and bg.charttime
where bg.lastRowSpO2 = 1 -- only the row with the most recent SpO2 (if no SpO2 found lastRowSpO2 = 1)
)

select subject_id, hadm_id,
icustay_id, charttime
, specimen -- raw data indicating sample type, only present 80% of the time

-- prediction of specimen for missing data
, case
      when SPECIMEN is not null then SPECIMEN
      when SPECIMEN_PROB > 0.75 then 'ART'
    else null end as SPECIMEN_PRED
, specimen_prob
-- oxygen related parameters
, so2, spo2 -- note spo2 is FROM chartevents
, po2, pco2
, fio2_chartevents, fio2
, aado2
-- also calculate AADO2
, case
    when  PO2 is not null
      and pco2 is not null
      and coalesce(fio2, fio2_chartevents) is not null
     -- multiple by 100 because FiO2 is in a % but should be a fraction
      then (coalesce(fio2, fio2_chartevents)/100) * (760 - 47) - (pco2/0.8) - po2
    else null
  end as AADO2_calc
, case
    when PO2 is not null and coalesce(fio2, fio2_chartevents) is not null
     -- multiply by 100 because FiO2 is in a % but should be a fraction
      then 100*PO2/(coalesce(fio2, fio2_chartevents))
    else null
  end as PaO2FiO2
-- acid-base parameters
, ph, baseexcess
, bicarbonate, totalco2

-- blood count parameters
, hematocrit
, hemoglobin
, carboxyhemoglobin
, methemoglobin

-- chemistry
, chloride, calcium
, temperature
, potassium, sodium
, lactate
, glucose

-- ventilation stuff that's sometimes input
, intubated, tidalvolume, ventilationrate, ventilator
, peep, o2flow
, requiredo2

from stg3
where lastRowFiO2 = 1 -- only the most recent FiO2
-- restrict it to *only* arterial samples
and (specimen = 'ART' or specimen_prob > 0.75)
order by icustay_id, charttime
  );",,,,,,,,,"dbt"
2022-07-29 16:01:25.493 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,9,"CREATE TABLE AS",2022-07-29 16:01:25 PDT,3/2221,1936,LOG,00000,"duration: 21.473 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.504 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,10,"idle in transaction",2022-07-29 16:01:25 PDT,3/2221,1936,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
alter table ""mimic"".""public"".""blood_gas_first_day_arterial"" rename to ""blood_gas_first_day_arterial__dbt_backup""",,,,,,,,,"dbt"
2022-07-29 16:01:25.505 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,11,"ALTER TABLE",2022-07-29 16:01:25 PDT,3/2221,1936,LOG,00000,"duration: 0.279 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.518 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,12,"idle in transaction",2022-07-29 16:01:25 PDT,3/2221,1936,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
alter table ""mimic"".""public"".""blood_gas_first_day_arterial__dbt_tmp"" rename to ""blood_gas_first_day_arterial""",,,,,,,,,"dbt"
2022-07-29 16:01:25.518 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,13,"ALTER TABLE",2022-07-29 16:01:25 PDT,3/2221,1936,LOG,00000,"duration: 0.256 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.530 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,14,"idle in transaction",2022-07-29 16:01:25 PDT,3/2221,1936,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:25.531 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,15,"COMMIT",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 1.107 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.538 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,16,"idle",2022-07-29 16:01:25 PDT,3/2222,0,LOG,00000,"statement: /* {""app"": ""dbt"", ""dbt_version"": ""1.1.1"", ""profile_name"": ""mimic"", ""target_name"": ""dev"", ""node_id"": ""model.mimic.blood_gas_first_day_arterial""} */
drop table if exists ""mimic"".""public"".""blood_gas_first_day_arterial__dbt_backup"" cascade",,,,,,,,,"dbt"
2022-07-29 16:01:25.540 PDT,"ceci","mimic",64803,"localhost:51524",62e466c5.fd23,17,"DROP TABLE",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 2.376 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.561 PDT,,,64804,"localhost:51526",62e466c5.fd24,1,"",2022-07-29 16:01:25 PDT,,0,LOG,00000,"connection received: host=localhost port=51526",,,,,,,,,""
2022-07-29 16:01:25.566 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,2,"authentication",2022-07-29 16:01:25 PDT,3/2223,0,LOG,00000,"connection authorized: user=ceci database=mimic application_name=dbt SSL enabled (protocol=TLSv1.3, cipher=TLS_AES_256_GCM_SHA384, bits=256, compression=off)",,,,,,,,,""
2022-07-29 16:01:25.568 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,3,"idle",2022-07-29 16:01:25 PDT,3/2224,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.569 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,4,"BEGIN",2022-07-29 16:01:25 PDT,3/2224,0,LOG,00000,"duration: 0.154 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.569 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,5,"idle in transaction",2022-07-29 16:01:25 PDT,3/2224,0,LOG,00000,"statement: BEGIN",,,,,,,,,"dbt"
2022-07-29 16:01:25.569 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,6,"BEGIN",2022-07-29 16:01:25 PDT,3/2224,0,WARNING,25001,"there is already a transaction in progress",,,,,,,,,"dbt"
2022-07-29 16:01:25.569 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,7,"BEGIN",2022-07-29 16:01:25 PDT,3/2224,0,LOG,00000,"duration: 0.106 ms",,,,,,,,,"dbt"
2022-07-29 16:01:25.576 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,8,"idle in transaction",2022-07-29 16:01:25 PDT,3/2224,0,LOG,00000,"statement: COMMIT",,,,,,,,,"dbt"
2022-07-29 16:01:25.576 PDT,"ceci","mimic",64804,"localhost:51526",62e466c5.fd24,9,"COMMIT",2022-07-29 16:01:25 PDT,3/0,0,LOG,00000,"duration: 0.142 ms",,,,,,,,,"dbt"
2022-07-31 02:50:47.369 PDT,,,30229,,62e3580b.7615,3,,2022-07-28 20:46:19 PDT,,0,LOG,00000,"received smart shutdown request",,,,,,,,,""
